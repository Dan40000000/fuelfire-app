<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Calorie Tracker - Well Fit</title>
    <link rel="stylesheet" href="styles.css">
    <script src="global-nav.js"></script>
    <script src="quick-food-entry.js"></script>
</head>
<body>
    <div class="phone-container">
        <div class="screen">
            <!-- Status Bar -->
            <div class="status-bar">
                
                
            </div>

            
            <div class="header">
                <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
                <div class="header-title">Calorie Tracker</div>
            </div>
            
            <div class="content">
                <div style="padding: 20px;">
                    <!-- Today's Summary -->
                    <div style="background: var(--gradient-1); color: white; padding: 25px; border-radius: 20px; margin-bottom: 25px; text-align: center;">
                        <h2 style="font-size: 18px; margin-bottom: 10px;">üìÖ Today's Progress</h2>
                        <div style="font-size: 48px; font-weight: bold; margin: 10px 0;" id="calories-today">0</div>
                        <div style="font-size: 14px; opacity: 0.9;">calories consumed</div>
                        <div style="margin-top: 20px; background: rgba(255,255,255,0.2); border-radius: 10px; padding: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 14px;">
                                <div style="text-align: center;">
                                    <div style="font-weight: bold;">Base Target</div>
                                    <div id="calorie-target">2000</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold;">Active Burned</div>
                                    <div id="active-burned">0</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold;">Adjusted Target</div>
                                    <div id="adjusted-target">2000</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-weight: bold;">Balance</div>
                                    <div id="calories-remaining">2000</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Macro Tracking -->
                    <div style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: var(--primary); margin-bottom: 20px; text-align: center;">üìä Macro Breakdown</h3>
                        
                        <!-- Protein -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: bold; color: #e74c3c;">ü•© Protein</div>
                                <div style="font-size: 14px; color: #666;">
                                    <span id="protein-consumed">0</span>g / <span id="protein-target">150</span>g
                                </div>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; height: 12px; overflow: hidden;">
                                <div id="protein-bar" style="background: linear-gradient(90deg, #e74c3c, #c0392b); height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        
                        <!-- Carbs -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: bold; color: #f39c12;">üçû Carbs</div>
                                <div style="font-size: 14px; color: #666;">
                                    <span id="carbs-consumed">0</span>g / <span id="carbs-target">200</span>g
                                </div>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; height: 12px; overflow: hidden;">
                                <div id="carbs-bar" style="background: linear-gradient(90deg, #f39c12, #e67e22); height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        
                        <!-- Fat -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: bold; color: #27ae60;">ü•ë Fat</div>
                                <div style="font-size: 14px; color: #666;">
                                    <span id="fat-consumed">0</span>g / <span id="fat-target">67</span>g
                                </div>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; height: 12px; overflow: hidden;">
                                <div id="fat-bar" style="background: linear-gradient(90deg, #27ae60, #229954); height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                        
                        <!-- Sugar -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-weight: bold; color: #e74c3c;">üç≠ Sugar</div>
                                <div style="font-size: 14px; color: #666;">
                                    <span id="sugar-consumed">0</span>g / <span id="sugar-target">25</span>g
                                </div>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; height: 12px; overflow: hidden;">
                                <div id="sugar-bar" style="background: linear-gradient(90deg, #3498db, #2980b9); height: 100%; width: 0%; border-radius: 10px; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="text-align: center; margin-top: 5px; font-size: 12px;">
                                <span id="sugar-status" style="font-weight: bold;">Within Limit</span>
                            </div>
                        </div>
                        
                        <!-- Macro Summary -->
                        <div style="background: #f8f9ff; border-radius: 10px; padding: 15px; margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                                <div>
                                    <div style="font-size: 20px; font-weight: bold; color: #e74c3c;" id="protein-percent">0%</div>
                                    <div style="font-size: 12px; color: #666;">Protein Goal</div>
                                </div>
                                <div>
                                    <div style="font-size: 20px; font-weight: bold; color: #f39c12;" id="carbs-percent">0%</div>
                                    <div style="font-size: 12px; color: #666;">Carbs Goal</div>
                                </div>
                                <div>
                                    <div style="font-size: 20px; font-weight: bold; color: #27ae60;" id="fat-percent">0%</div>
                                    <div style="font-size: 12px; color: #666;">Fat Goal</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Epic Food Logging Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);">
                        <h3 style="color: white; text-align: center; margin: 0 0 15px 0; font-size: 20px;">üî• LOG YOUR FUEL üî•</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <button onclick="startBarcodeScanning()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 15px 10px; border-radius: 15px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                                üì∑<br>Scan
                            </button>
                            <button onclick="startVoiceLogging()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 15px 10px; border-radius: 15px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                                üé§<br>Voice
                            </button>
                            <button onclick="showSmartEntry()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 15px 10px; border-radius: 15px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                                ‚å®Ô∏è<br>Type
                            </button>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px;">
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 8px;">QUICK ADD FROM HISTORY:</div>
                            <div id="quick-adds" style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;">
                                <!-- Quick add buttons will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Import Options -->
                    <div style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: var(--primary); margin: 0 0 15px 0; text-align: center; font-size: 18px;">‚ö° Quick Import</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <button onclick="showMealPlanSelector()" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 15px 12px; border: none; border-radius: 15px; font-weight: bold; box-shadow: 0 3px 15px rgba(76, 175, 80, 0.3); font-size: 14px; cursor: pointer; transition: all 0.3s ease;">
                                üçΩÔ∏è<br>Meal Plans
                            </button>
                            <button onclick="showMealIdeasSelector()" style="background: linear-gradient(135deg, #ff9800, #f57c00); color: white; padding: 15px 12px; border: none; border-radius: 15px; font-weight: bold; box-shadow: 0 3px 15px rgba(255, 152, 0, 0.3); font-size: 14px; cursor: pointer; transition: all 0.3s ease;">
                                üí°<br>Meal Ideas
                            </button>
                        </div>
                        <div style="text-align: center; margin-top: 12px; font-size: 12px; color: #666;">
                            Import complete meals with one tap!
                        </div>
                    </div>

                    <!-- Quick Add Common Items -->
                    <div style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h3 style="color: var(--primary); margin: 0; font-size: 18px;">‚ö° Quick Add</h3>
                            <button onclick="showQuickAddManager()" style="background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer;">
                                + Manage
                            </button>
                        </div>
                        <div id="quick-add-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <!-- Quick add items will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Today's Meals -->
                    <div style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">üçΩÔ∏è Today's Meals</h3>
                        <div id="today-meals">
                            <p style="text-align: center; color: #999; padding: 20px;">No meals logged yet today</p>
                        </div>
                    </div>
                    
                    <!-- Weekly Summary -->
                    <div style="background: white; border-radius: 20px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">üìä This Week</h3>
                        <div id="weekly-chart" style="height: 150px; display: flex; align-items: flex-end; justify-content: space-around;">
                            <!-- Weekly bar chart will go here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Navigation Bar -->
            <div class="bottom-nav">
                <!-- Quick Workout -->
                <div class="nav-item" onclick="window.location.href='workout-quiz.html'">
                    <div class="nav-glow"></div>
                    <div class="nav-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="2" y="9" width="4" height="6" rx="1" fill="white"/>
                            <rect x="18" y="9" width="4" height="6" rx="1" fill="white"/>
                            <rect x="6" y="11" width="12" height="2" rx="1" fill="white"/>
                            <circle cx="4" cy="12" r="1.5" fill="#4B9CD3"/>
                            <circle cx="20" cy="12" r="1.5" fill="#4B9CD3"/>
                        </svg>
                    </div>
                </div>
                <!-- Food Tracker -->
                <div class="nav-item" onclick="showQuickFoodEntry()">
                    <div class="nav-glow"></div>
                    <div class="nav-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="9" stroke="white" stroke-width="2" fill="none"/>
                            <path d="M12 3C12 3 16 8 16 12C16 14.2 14.2 16 12 16C9.8 16 8 14.2 8 12C8 8 12 3 12 3Z" stroke="white" stroke-width="2" fill="none"/>
                        </svg>
                    </div>
                </div>
                <!-- Home (Center, Larger) -->
                <div class="nav-item" onclick="window.location.href='index.html'" style="transform: scale(1.2);">
                    <div class="nav-glow"></div>
                    <div class="nav-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 22V12H15V22" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                </div>
                <!-- Health Dashboard -->
                <div class="nav-item" onclick="window.location.href='health-dashboard.html'">
                    <div class="nav-glow"></div>
                    <div class="nav-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.27 2 8.5C2 5.41 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.08C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.41 22 8.5C22 12.27 18.6 15.36 13.45 20.03L12 21.35Z" fill="white"/>
                        </svg>
                    </div>
                </div>
                <!-- Diet Plan -->
                <div class="nav-item" onclick="window.location.href='workout-techniques.html'">
                    <div class="nav-glow"></div>
                    <div class="nav-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                            <circle cx="12" cy="12" r="2" fill="white"/>
                            <path d="M12 2V12L18 18" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay for sidebar -->
    <div class="overlay" onclick="toggleSidebar()"></div>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">üî• Well Fit</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item" onclick="window.location.href='index.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Home
            </div>
            <div class="menu-item" onclick="goToScreen('index.html', 'create-workout')" ontouchstart="" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <rect x="2" y="9" width="4" height="6" rx="1" fill="currentColor"/>
                    <rect x="18" y="9" width="4" height="6" rx="1" fill="currentColor"/>
                    <rect x="6" y="11" width="12" height="2" rx="1" fill="currentColor"/>
                    <circle cx="4" cy="12" r="1.5" fill="#fff"/>
                    <circle cx="20" cy="12" r="1.5" fill="#fff"/>
                </svg>
                Create Workout
            </div>
            <div class="menu-item" onclick="goToScreen('index.html', 'saved-workouts')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9L11 5H19C19.5304 5 20.0391 5.21071 20.4142 5.58579C20.7893 5.96086 21 6.46957 21 7V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Saved Workouts
            </div>
            <div class="menu-item" onclick="goToScreen('index.html', 'track-workouts')" ontouchstart="" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M3 3V18C3 18.5304 3.21071 19.0391 3.58579 19.4142C3.96086 19.7893 4.46957 20 5 20H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 14L12 9L16 13L21 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Track Workouts
            </div>
            <div class="menu-item active" onclick="window.location.href='calorie-tracker.html'" ontouchstart="" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M13.5 0.67C13.5 0.67 14.24 3.32 14.24 5.47C14.24 7.53 12.89 9.2 10.83 9.2C8.76 9.2 7.2 7.53 7.2 5.47L7.23 5.1C5.21 7.5 4 10.61 4 14C4 19.5 8.5 24 14 24C19.5 24 24 19.5 24 14C24 8.36 18.37 3.29 13.5 0.67Z" fill="currentColor"/>
                </svg>
                Calorie Tracker
            </div>
            <div class="menu-item" onclick="window.location.href='health-dashboard.html'" ontouchstart="" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.27 2 8.5C2 5.41 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.08C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.41 22 8.5C22 12.27 18.6 15.36 13.45 20.03L12 21.35Z" fill="currentColor"/>
                </svg>
                Health Dashboard
            </div>
            <div class="menu-item" onclick="window.location.href='enhanced-diet-quiz.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                    <circle cx="12" cy="12" r="2" fill="currentColor"/>
                    <path d="M12 2V12L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Diet Creation
            </div>
            <div class="menu-item" onclick="window.location.href='meal-plans.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M12 3C12 3 16 8 16 12C16 14.2 14.2 16 12 16C9.8 16 8 14.2 8 12C8 8 12 3 12 3Z" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
                Meal Plans
            </div>
            <div class="menu-item" onclick="window.location.href='meal-ideas.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M12 1V3M12 21V23M23 12H21M3 12H1M20.49 3.51L18.36 5.64M5.64 18.36L3.51 20.49M20.49 20.49L18.36 18.36M5.64 5.64L3.51 3.51" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Meal Ideas
            </div>
            <div class="menu-item" onclick="window.location.href='supplements.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <rect x="9" y="2" width="6" height="20" rx="3" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M9 8H15M9 12H15M9 16H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Supplements
            </div>
            <div class="menu-item" onclick="window.location.href='workout-techniques.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <circle cx="8" cy="8" r="2" fill="currentColor"/>
                    <path d="M8 10V14M8 14L6 20M8 14L10 20M8 14L12 12M12 12L10 6M12 12L14 6M12 12L16 14M16 14L14 20M16 14L18 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Workout Techniques
            </div>
            <div class="menu-item" onclick="goToScreen('index.html', 'progress')" ontouchstart="" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M18 20V10M12 20V4M6 20V14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Goals & Progress
            </div>
        </div>
    </div>
    
    <!-- Manual Entry Modal -->
    <div id="manual-entry-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
        <div style="position: relative; top: 5vh; left: 50%; transform: translateX(-50%); background: white; border-radius: 20px; padding: 20px; width: 90%; max-width: 400px; margin-bottom: 5vh;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">üçé Log Your Fuel</h3>
            
            <!-- Saved Meals Quick Import -->
            <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <h4 style="margin: 0 0 10px 0; color: var(--primary); font-size: 14px;">‚ö° Quick Import</h4>
                <select id="saved-meals-select" onchange="loadSavedMeal()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    <option value="">Select saved meal...</option>
                </select>
            </div>

            <!-- Manual Entry Form -->
            <input type="text" id="food-name" placeholder="Food name" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px;">
            
            <!-- Macro Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <input type="number" id="food-calories" placeholder="Calories" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px;">
                <input type="number" id="food-protein" placeholder="Protein (g)" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px;">
                <input type="number" id="food-carbs" placeholder="Carbs (g)" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px;">
                <input type="number" id="food-fat" placeholder="Fat (g)" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px;">
            </div>
            
            <!-- Sugar Input -->
            <input type="number" id="food-sugar" placeholder="Sugar (g)" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px;">
            
            <!-- Save Option -->
            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; font-size: 14px; color: #666;">
                    <input type="checkbox" id="save-meal-checkbox" style="margin-right: 8px;">
                    üíæ Save this meal for future use
                </label>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="addManualFood()" style="flex: 1; background: var(--gradient-1); color: white; border: none; padding: 12px; border-radius: 15px; font-weight: bold;">Add to Log</button>
                <button onclick="hideManualEntryModal()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 15px; font-weight: bold;">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Meal Plan Selector Modal -->
    <div id="meal-plan-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">üçΩÔ∏è Log from Meal Plan</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">Select Meal Plan:</label>
                <select id="meal-plan-select" onchange="loadMealPlanMeals()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px;">
                    <option value="">Choose a meal plan...</option>
                </select>
            </div>
            
            <div id="meal-plan-meals" style="display: none;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">Select Meal:</label>
                <select id="meal-select" onchange="showMealTypeSelector()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px;">
                    <option value="">Choose a meal...</option>
                </select>
                
                <div id="meal-type-selector" style="display: none; margin-bottom: 20px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 8px;">Log as:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="logMealFromPlan('breakfast')" style="background: #FF6B6B; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">üç≥ Breakfast</button>
                        <button onclick="logMealFromPlan('lunch')" style="background: #4ECDC4; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">ü•ó Lunch</button>
                        <button onclick="logMealFromPlan('dinner')" style="background: #3AA69D; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">üçΩÔ∏è Dinner</button>
                        <button onclick="logMealFromPlan('snack')" style="background: #F38181; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">üçé Snack</button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="hideMealPlanSelector()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 15px; font-weight: bold;">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Meal Ideas Modal -->
    <div id="meal-ideas-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">üí° Log from Meal Ideas</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">Select Category:</label>
                <select id="meal-category-select" onchange="loadMealIdeasByCategory()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px;">
                    <option value="">Choose a category...</option>
                    <option value="beef">ü•© Beef</option>
                    <option value="chicken">üçó Chicken</option>
                    <option value="pork">ü•ì Pork</option>
                    <option value="shrimp">üç§ Shrimp</option>
                    <option value="turkey">ü¶É Turkey</option>
                    <option value="sandwiches">ü•™ Epic Sandwiches</option>
                    <option value="keto">ü•ë Keto</option>
                    <option value="fusion">üåç Fusion</option>
                </select>
            </div>
            
            <div id="meal-ideas-list" style="display: none;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">Select Meal:</label>
                <select id="meal-idea-select" onchange="showMealIdeaTypeSelector()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px;">
                    <option value="">Choose a meal...</option>
                </select>
                
                <div id="meal-idea-type-selector" style="display: none; margin-bottom: 20px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 8px;">Log as:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="logMealFromIdea('breakfast')" style="background: #FF6B6B; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">üç≥ Breakfast</button>
                        <button onclick="logMealFromIdea('lunch')" style="background: #4ECDC4; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">ü•ó Lunch</button>
                        <button onclick="logMealFromIdea('dinner')" style="background: #3AA69D; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">üçΩÔ∏è Dinner</button>
                        <button onclick="logMealFromIdea('snack')" style="background: #F38181; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">üçé Snack</button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="hideMealIdeasSelector()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 15px; font-weight: bold;">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Voice Modal -->
    <div id="voice-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
        <div style="position: relative; top: 5vh; left: 50%; transform: translateX(-50%); background: white; border-radius: 20px; padding: 20px; width: 90%; max-width: 400px; margin-bottom: 5vh; text-align: center;">
            <h3 style="color: var(--primary); margin-bottom: 15px;">üé§ Voice Logging</h3>
            <div id="voice-status" style="font-size: 48px; margin: 15px 0;">üé§</div>
            <div id="voice-text" style="min-height: 50px; max-height: 400px; overflow-y: auto; padding: 15px; background: #f0f0f0; border-radius: 10px; margin-bottom: 15px; font-style: italic;">
                Click the microphone to start speaking...
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="toggleVoiceRecording()" id="voice-button" style="background: #FF6B6B; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1; min-width: 140px;">
                    Start Recording
                </button>
                <button onclick="closeVoiceModal()" style="background: #6c757d; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1; min-width: 140px;">
                    Cancel
                </button>
            </div>
            <div id="food-results" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Smart Entry Modal -->
    <div id="smart-entry-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
        <div style="position: relative; top: 5vh; left: 50%; transform: translateX(-50%); background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 450px; margin-bottom: 5vh;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">‚å®Ô∏è Add Food</h3>
            
            <!-- Tab buttons -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="ai-search-tab" onclick="showAISearch()" style="flex: 1; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold;">ü§ñ AI Search</button>
                <button id="manual-entry-tab" onclick="showManualEntry()" style="flex: 1; padding: 10px; background: #e0e0e0; color: #666; border: none; border-radius: 10px; font-weight: bold;">‚úèÔ∏è Manual Entry</button>
            </div>
            
            <!-- AI Search Tab -->
            <div id="ai-search-content">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="smart-search" placeholder="e.g. 'Big Mac with fries'" 
                           onkeypress="if(event.key==='Enter') searchFood(this.value)" 
                           style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
                    <button onclick="searchFood(document.getElementById('smart-search').value)" style="background: var(--primary); color: white; border: none; padding: 15px 25px; border-radius: 10px; font-weight: bold;">Search</button>
                </div>
                
                <!-- Quick suggestions -->
                <div style="margin-top: 15px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">QUICK PICKS:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button onclick="document.getElementById('smart-search').value='chicken breast'; searchFood('chicken breast')" style="background: #f0f0f0; border: 1px solid #ddd; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer;">üçó Chicken</button>
                        <button onclick="document.getElementById('smart-search').value='eggs and toast'; searchFood('eggs and toast')" style="background: #f0f0f0; border: 1px solid #ddd; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer;">üç≥ Eggs</button>
                        <button onclick="document.getElementById('smart-search').value='protein shake'; searchFood('protein shake')" style="background: #f0f0f0; border: 1px solid #ddd; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer;">ü•§ Shake</button>
                        <button onclick="document.getElementById('smart-search').value='salad'; searchFood('salad')" style="background: #f0f0f0; border: 1px solid #ddd; padding: 6px 12px; border-radius: 15px; font-size: 12px; cursor: pointer;">ü•ó Salad</button>
                    </div>
                </div>
                
                <div id="search-results" style="margin-top: 20px; max-height: 200px; overflow-y: auto;"></div>
            </div>
            
            <!-- Manual Entry Tab -->
            <div id="manual-entry-content" style="display: none;">
                <input type="text" id="manual-food-name" placeholder="Food name" style="width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 12px; box-sizing: border-box;">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                    <input type="number" id="manual-calories" placeholder="Calories" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; box-sizing: border-box;">
                    <input type="number" id="manual-protein" placeholder="Protein (g)" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; box-sizing: border-box;">
                    <input type="number" id="manual-carbs" placeholder="Carbs (g)" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; box-sizing: border-box;">
                    <input type="number" id="manual-fat" placeholder="Fat (g)" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; box-sizing: border-box;">
                    <input type="number" id="manual-sugar" placeholder="Sugar (g)" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; box-sizing: border-box;">
                </div>

                <button onclick="addManualFood()" style="width: 100%; background: #4CAF50; color: white; border: none; padding: 12px; border-radius: 10px; font-size: 15px; font-weight: bold;">Add Food</button>
            </div>
            
            <button onclick="closeSmartEntry()" style="background: #6c757d; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; margin-top: 20px; width: 100%;">
                Cancel
            </button>
        </div>
    </div>

    <!-- Quick Add Manager Modal -->
    <div id="quick-add-manager-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
        <div style="position: relative; top: 5vh; left: 50%; transform: translateX(-50%); background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 450px; margin-bottom: 5vh;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">‚ö° Manage Quick Add Items</h3>

            <!-- Current Quick Add Items -->
            <div style="margin-bottom: 25px;">
                <h4 style="font-size: 14px; color: #666; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">Your Quick Add Items:</h4>
                <div id="quick-add-items-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Items will be loaded here -->
                </div>
            </div>

            <!-- Add New Item Form -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h4 style="font-size: 14px; color: var(--primary); margin: 0 0 15px 0; font-weight: bold;">‚ûï Add New Item</h4>

                <input type="text" id="qa-name" placeholder="Item name (e.g., Protein Power)" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 12px; box-sizing: border-box;">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <input type="number" id="qa-calories" placeholder="Calories" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">
                    <input type="number" id="qa-protein" placeholder="Protein (g)" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">
                    <input type="number" id="qa-carbs" placeholder="Carbs (g)" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">
                    <input type="number" id="qa-fat" placeholder="Fat (g)" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">
                </div>

                <button onclick="addQuickAddItem()" style="width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer;">
                    ‚ûï Add Item
                </button>
            </div>

            <button onclick="closeQuickAddManager()" style="width: 100%; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer;">
                Done
            </button>
        </div>
    </div>

    <!-- Edit Meal Modal -->
    <div id="edit-meal-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
        <div style="position: relative; top: 5vh; left: 50%; transform: translateX(-50%); background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 450px; margin-bottom: 5vh;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">Edit Meal</h3>

            <input type="text" id="edit-food-name" placeholder="Food name" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 12px; box-sizing: border-box;">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                <input type="number" id="edit-calories" placeholder="Calories" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">
                <input type="number" id="edit-protein" placeholder="Protein (g)" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">
                <input type="number" id="edit-carbs" placeholder="Carbs (g)" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">
                <input type="number" id="edit-fat" placeholder="Fat (g)" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">
                <input type="number" id="edit-sugar" placeholder="Sugar (g)" style="padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box;">
            </div>

            <input type="hidden" id="edit-meal-index">

            <div style="display: flex; gap: 10px;">
                <button onclick="saveMealEdit()" style="flex: 1; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer;">
                    Save Changes
                </button>
                <button onclick="closeEditMeal()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer;">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <script>
        // Helper function to get local date in YYYY-MM-DD format (not UTC)
        function getLocalDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Active Calories Functions (for balance calculator)
        function getTodayWorkoutCalories() {
            const workoutHistory = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let totalWorkoutCalories = 0;

            workoutHistory.forEach(workout => {
                const workoutDate = new Date(workout.date);
                workoutDate.setHours(0, 0, 0, 0);

                if (workoutDate.getTime() === today.getTime()) {
                    // Use calories from workout if available, otherwise estimate
                    if (workout.calories) {
                        totalWorkoutCalories += workout.calories;
                    } else {
                        const duration = workout.duration || 45;
                        let caloriesPerMinute = 5;

                        if (workout.type) {
                            const type = workout.type.toLowerCase();
                            if (type.includes('chest') || type.includes('back') || type.includes('legs')) {
                                caloriesPerMinute = 7;
                            } else if (type.includes('cardio') || type.includes('hiit')) {
                                caloriesPerMinute = 10;
                            } else if (type.includes('arms') || type.includes('core')) {
                                caloriesPerMinute = 5;
                            }
                        }

                        totalWorkoutCalories += duration * caloriesPerMinute;
                    }
                }
            });

            return Math.round(totalWorkoutCalories);
        }

        function getTodayManualCalories() {
            const entries = JSON.parse(localStorage.getItem('fuelfire_active_calories') || '[]');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let totalManualCalories = 0;

            entries.forEach(entry => {
                const entryDate = new Date(entry.date);
                entryDate.setHours(0, 0, 0, 0);

                if (entryDate.getTime() === today.getTime()) {
                    totalManualCalories += entry.calories;
                }
            });

            return totalManualCalories;
        }

        function getAppleHealthActiveCalories() {
            // Get from cached health data
            const healthData = JSON.parse(localStorage.getItem('healthData') || '{}');
            return healthData.activeEnergy || 0;
        }

        function getTotalActiveCalories() {
            const appleHealthActive = getAppleHealthActiveCalories();
            const manualActive = getTodayManualCalories();
            const workoutActive = getTodayWorkoutCalories();

            // Use the highest value to avoid double-counting
            // (workouts might already be in Apple Health or manual entries)
            const totalActive = appleHealthActive + manualActive + workoutActive;

            console.log('üî• Active Calories Breakdown:');
            console.log('  Apple Health:', appleHealthActive);
            console.log('  Manual:', manualActive);
            console.log('  Workouts:', workoutActive);
            console.log('  Total:', totalActive);

            return totalActive;
        }

        // Voice Recognition
        let recognition = null;
        let isRecording = false;

        function startVoiceLogging() {
            // Stop and clear any existing recognition
            if (recognition) {
                try {
                    recognition.stop();
                    recognition.abort();
                } catch (e) {
                    console.log('Clearing old recognition:', e);
                }
                recognition = null;
            }
            isRecording = false;

            // Reset modal UI
            document.getElementById('voice-modal').style.display = 'block';
            document.getElementById('voice-text').textContent = 'Click the microphone to start speaking...';
            document.getElementById('voice-button').textContent = 'Start Recording';
            document.getElementById('voice-button').style.background = '#FF6B6B';
            document.getElementById('voice-status').textContent = 'üé§';
            document.getElementById('food-results').innerHTML = '';

            // Create FRESH recognition object every time
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            let finalTranscript = '';
            let recognitionTimeout = null;

            recognition.onresult = function(event) {
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                document.getElementById('voice-text').textContent = (finalTranscript + interimTranscript).trim() || 'Listening...';

                // Reset timeout on any speech
                clearTimeout(recognitionTimeout);
                recognitionTimeout = setTimeout(() => {
                    if (finalTranscript.trim()) {
                        recognition.stop();
                    }
                }, 3000); // Stop 3 seconds after last speech
            };

            recognition.onend = function() {
                if (isRecording && finalTranscript.trim()) {
                    isRecording = false;
                    document.getElementById('voice-button').textContent = 'Processing...';
                    document.getElementById('voice-button').style.background = '#6c757d';
                    document.getElementById('voice-status').textContent = 'ü§ñ';

                    // Search for food using AI
                    searchFoodByVoice(finalTranscript.trim());
                    finalTranscript = '';
                }
            };
            
            recognition.onerror = function(event) {
                document.getElementById('voice-text').textContent = 'Error: ' + event.error;
                isRecording = false;
                document.getElementById('voice-button').textContent = 'Start Recording';
                document.getElementById('voice-button').style.background = '#FF6B6B';
                document.getElementById('voice-status').textContent = 'üé§';
            };
        }
        
        function toggleVoiceRecording() {
            if (!isRecording) {
                recognition.start();
                isRecording = true;
                document.getElementById('voice-button').textContent = 'Stop Recording';
                document.getElementById('voice-button').style.background = '#28a745';
                document.getElementById('voice-status').textContent = 'üî¥';
            } else {
                // Manual stop - process whatever we have
                const currentText = document.getElementById('voice-text').textContent;
                
                recognition.stop();
                isRecording = false;
                
                if (currentText && currentText !== 'Click the microphone to start speaking...' && currentText.trim().length > 0) {
                    // Process the current text
                    document.getElementById('voice-button').textContent = 'Processing...';
                    document.getElementById('voice-button').style.background = '#6c757d';
                    document.getElementById('voice-status').textContent = 'ü§ñ';
                    
                    console.log('üé§ Manual stop - processing:', currentText);
                    searchFoodByVoice(currentText);
                } else {
                    // No text captured
                    document.getElementById('voice-button').textContent = 'Start Recording';
                    document.getElementById('voice-button').style.background = '#FF6B6B';
                    document.getElementById('voice-status').textContent = 'üé§';
                    document.getElementById('voice-text').textContent = 'No speech detected. Try again.';
                }
            }
        }

        // Quick add common items (protein shakes, supplements, etc.)
        function quickAddItem(name, calories, protein, carbs, fat) {
            const food = {
                name: name,
                calories: calories,
                protein: protein,
                carbs: carbs,
                fat: fat,
                sugar: 0
            };

            logFood(food);

            // Show success feedback
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '‚úì Added!';
            btn.style.transform = 'scale(0.95)';

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.transform = 'scale(1)';
            }, 1000);
        }

        // Quick Add Management Functions
        function getDefaultQuickAddItems() {
            return [
                { name: 'Protein Power', calories: 150, protein: 30, carbs: 3, fat: 2, color: '#9C27B0' }
            ];
        }

        function loadQuickAddGrid() {
            let quickAdds = JSON.parse(localStorage.getItem('quickAddItems') || 'null');

            // Initialize with default if empty
            if (!quickAdds || quickAdds.length === 0) {
                quickAdds = getDefaultQuickAddItems();
                localStorage.setItem('quickAddItems', JSON.stringify(quickAdds));
            }

            const grid = document.getElementById('quick-add-grid');
            if (!grid) return;

            const colors = ['#9C27B0', '#f44336', '#2196F3', '#00BCD4', '#795548', '#FF9800', '#4CAF50', '#E91E63', '#3F51B5'];

            grid.innerHTML = quickAdds.map((item, index) => {
                const color = item.color || colors[index % colors.length];
                return `
                    <button onclick="quickAddItem('${item.name.replace(/'/g, "\\'")}', ${item.calories}, ${item.protein}, ${item.carbs}, ${item.fat})"
                            style="background: linear-gradient(135deg, ${color}, ${color}dd); color: white; padding: 20px; border: none; border-radius: 15px; font-weight: bold; box-shadow: 0 3px 12px ${color}40; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1.3;">
                        ${item.name}
                    </button>
                `;
            }).join('');
        }

        function showQuickAddManager() {
            document.getElementById('quick-add-manager-modal').style.display = 'block';
            loadQuickAddItemsList();
        }

        function closeQuickAddManager() {
            document.getElementById('quick-add-manager-modal').style.display = 'none';
            // Clear form
            document.getElementById('qa-name').value = '';
            document.getElementById('qa-calories').value = '';
            document.getElementById('qa-protein').value = '';
            document.getElementById('qa-carbs').value = '';
            document.getElementById('qa-fat').value = '';
            // Reload quick add grid
            loadQuickAddGrid();
        }

        function loadQuickAddItemsList() {
            let quickAdds = JSON.parse(localStorage.getItem('quickAddItems') || 'null');
            if (!quickAdds || quickAdds.length === 0) {
                quickAdds = getDefaultQuickAddItems();
            }

            const list = document.getElementById('quick-add-items-list');
            list.innerHTML = quickAdds.map((item, index) => `
                <div style="display: flex; align-items: center; justify-content: space-between; background: white; padding: 12px; border-radius: 10px; border: 2px solid #e0e0e0;">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: var(--primary); font-size: 16px;">${item.name}</div>
                            <div style="font-size: 11px; color: #666;">${item.calories} cal | ${item.protein}g P | ${item.carbs}g C | ${item.fat}g F</div>
                        </div>
                    </div>
                    <button onclick="deleteQuickAddItem(${index})" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold;">
                        Delete
                    </button>
                </div>
            `).join('');
        }

        function addQuickAddItem() {
            const name = document.getElementById('qa-name').value.trim();
            const calories = parseFloat(document.getElementById('qa-calories').value) || 0;
            const protein = parseFloat(document.getElementById('qa-protein').value) || 0;
            const carbs = parseFloat(document.getElementById('qa-carbs').value) || 0;
            const fat = parseFloat(document.getElementById('qa-fat').value) || 0;

            if (!name) {
                alert('Please enter an item name');
                return;
            }

            const colors = ['#9C27B0', '#f44336', '#2196F3', '#00BCD4', '#795548', '#FF9800', '#4CAF50', '#E91E63', '#3F51B5'];
            const newItem = {
                name,
                calories,
                protein,
                carbs,
                fat,
                color: colors[Math.floor(Math.random() * colors.length)]
            };

            let quickAdds = JSON.parse(localStorage.getItem('quickAddItems') || 'null');
            if (!quickAdds) quickAdds = [];

            quickAdds.push(newItem);
            localStorage.setItem('quickAddItems', JSON.stringify(quickAdds));

            // Clear form
            document.getElementById('qa-name').value = '';
            document.getElementById('qa-calories').value = '';
            document.getElementById('qa-protein').value = '';
            document.getElementById('qa-carbs').value = '';
            document.getElementById('qa-fat').value = '';

            // Reload list
            loadQuickAddItemsList();
        }

        function deleteQuickAddItem(index) {
            if (!confirm('Delete this quick add item?')) return;

            let quickAdds = JSON.parse(localStorage.getItem('quickAddItems') || '[]');
            quickAdds.splice(index, 1);
            localStorage.setItem('quickAddItems', JSON.stringify(quickAdds));

            loadQuickAddItemsList();
        }

        // Barcode Scanner using Capacitor ML Kit
        async function startBarcodeScanning() {
            try {
                console.log('üì∑ Starting barcode scanner...');

                // Check if running in browser (web) or native app
                if (typeof Capacitor === 'undefined' || Capacitor.getPlatform() === 'web') {
                    alert('üì∑ Barcode scanning is only available in the mobile app.\n\nPlease use Voice or Manual entry for now.');
                    return;
                }

                // Import BarcodeScanner from Capacitor
                const { BarcodeScanner } = Capacitor.Plugins;

                if (!BarcodeScanner) {
                    console.error('BarcodeScanner plugin not found');
                    alert('Barcode scanner not available. Please use Voice or Manual entry.');
                    return;
                }

                // Check and request camera permissions
                console.log('üì∑ Checking camera permissions...');
                const permissionStatus = await BarcodeScanner.checkPermissions();
                console.log('üì∑ Permission status:', permissionStatus);

                if (permissionStatus.camera !== 'granted') {
                    console.log('üì∑ Requesting camera permission...');
                    const result = await BarcodeScanner.requestPermissions();
                    console.log('üì∑ Permission request result:', result);

                    if (result.camera !== 'granted') {
                        alert('üì∑ Camera access is required to scan barcodes.\n\nTo enable:\n1. Go to iPhone Settings\n2. Find "Well Fit Pro"\n3. Enable Camera access');
                        return;
                    }
                }

                // Start the scanner
                console.log('üì∑ Starting scan...');
                document.body.style.background = 'transparent';
                document.body.classList.add('barcode-scanning-active');

                const { barcodes } = await BarcodeScanner.scan();

                console.log('üì∑ Scan result:', barcodes);
                document.body.style.background = '';
                document.body.classList.remove('barcode-scanning-active');

                if (barcodes && barcodes.length > 0) {
                    const barcode = barcodes[0];
                    console.log('üì∑ Barcode detected:', barcode.displayValue || barcode.rawValue);
                    await searchByBarcode(barcode.displayValue || barcode.rawValue);
                } else {
                    console.log('üì∑ No barcode detected');
                    alert('No barcode detected. Please try again.');
                }

            } catch (error) {
                console.error('üì∑ Barcode scanning error:', error);
                document.body.style.background = '';

                alert('Camera Error: ' + (error.message || 'Unable to start scanner') + '\n\nPlease try again or use Voice/Manual entry.');
            }
        }

        async function searchByBarcode(barcode) {
            console.log('üîç Searching for barcode:', barcode);

            try {
                // Show loading in voice modal (reusing it for barcode results)
                document.getElementById('voice-modal').style.display = 'block';
                document.getElementById('voice-status').textContent = 'üîç';
                document.getElementById('voice-text').textContent = `Searching for barcode ${barcode}...`;
                document.getElementById('voice-button').style.display = 'none';

                // Search OpenFoodFacts API (completely free, no API key needed)
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();

                console.log('üîç OpenFoodFacts response:', data);

                if (data.status === 1 && data.product) {
                    const product = data.product;
                    const name = product.product_name || 'Unknown Product';
                    const brand = product.brands || '';
                    const fullName = brand ? `${brand} ${name}` : name;

                    // Get nutrition info (per serving if available, otherwise per 100g)
                    const servingSize = product.serving_size || '100g';
                    let calories = 0, protein = 0, carbs = 0, fat = 0, sugar = 0;

                    if (product.nutriments) {
                        // Try to get per-serving values first
                        if (product.nutriments['energy-kcal_serving']) {
                            calories = product.nutriments['energy-kcal_serving'] || 0;
                            protein = product.nutriments['proteins_serving'] || 0;
                            carbs = product.nutriments['carbohydrates_serving'] || 0;
                            fat = product.nutriments['fat_serving'] || 0;
                            sugar = product.nutriments['sugars_serving'] || 0;
                        } else {
                            // Fall back to per-100g values
                            calories = product.nutriments['energy-kcal_100g'] || product.nutriments['energy-kcal'] || 0;
                            protein = product.nutriments['proteins_100g'] || product.nutriments['proteins'] || 0;
                            carbs = product.nutriments['carbohydrates_100g'] || product.nutriments['carbohydrates'] || 0;
                            fat = product.nutriments['fat_100g'] || product.nutriments['fat'] || 0;
                            sugar = product.nutriments['sugars_100g'] || product.nutriments['sugars'] || 0;
                        }
                    }

                    // Round values
                    calories = Math.round(calories);
                    protein = Math.round(protein);
                    carbs = Math.round(carbs);
                    fat = Math.round(fat);
                    sugar = Math.round(sugar);

                    console.log('‚úÖ Product found:', { fullName, calories, protein, carbs, fat, sugar, servingSize });

                    // Show results with meal type selector
                    document.getElementById('voice-status').textContent = '‚úÖ';
                    document.getElementById('voice-text').innerHTML = `
                        <div style="text-align: left;">
                            <div style="font-weight: bold; margin-bottom: 10px; color: var(--primary);">Found Product:</div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">${fullName}</div>
                                <div style="font-size: 13px; color: #666;">
                                    üìä ${calories} cal | ü•© ${protein}g protein | üçû ${carbs}g carbs | ü•ë ${fat}g fat
                                    <br>üìè Serving: ${servingSize}
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Quantity:</label>
                                <input type="number" id="barcode-quantity" value="1" min="0.25" step="0.25"
                                       style="width: 100%; padding: 10px; border: 2px solid var(--primary); border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Log as:</label>
                                <select id="barcode-meal-type" style="width: 100%; padding: 10px; border: 2px solid var(--primary); border-radius: 8px; font-size: 14px;">
                                    <option value="breakfast">üåÖ Breakfast</option>
                                    <option value="lunch">‚òÄÔ∏è Lunch</option>
                                    <option value="dinner">üåô Dinner</option>
                                    <option value="snack">üçø Snack</option>
                                </select>
                            </div>
                        </div>
                    `;

                    // Show button and set up click handler
                    const logBtn = document.getElementById('voice-button');
                    logBtn.style.display = 'block';
                    logBtn.textContent = 'Log This Food';
                    logBtn.style.background = '#28a745';

                    // Remove old click handler
                    const newLogBtn = logBtn.cloneNode(true);
                    logBtn.parentNode.replaceChild(newLogBtn, logBtn);

                    // Add new click handler
                    newLogBtn.onclick = () => {
                        const quantity = parseFloat(document.getElementById('barcode-quantity').value) || 1;
                        const mealType = document.getElementById('barcode-meal-type').value;

                        const foodToLog = {
                            name: quantity !== 1 ? `${quantity}x ${fullName}` : fullName,
                            calories: Math.round(calories * quantity),
                            protein: Math.round(protein * quantity),
                            carbs: Math.round(carbs * quantity),
                            fat: Math.round(fat * quantity),
                            sugar: Math.round(sugar * quantity),
                            meal: mealType
                        };

                        logFood(foodToLog);

                        const mealEmoji = { 'breakfast': 'üåÖ', 'lunch': '‚òÄÔ∏è', 'dinner': 'üåô', 'snack': 'üçø' }[mealType] || 'üç¥';

                        document.getElementById('voice-text').textContent = `‚úÖ Logged to ${mealEmoji} ${mealType}!`;
                        document.getElementById('voice-status').textContent = 'üéâ';
                        setTimeout(() => closeVoiceModal(), 1000);
                    };

                } else {
                    // Product not found
                    console.log('‚ùå Product not found in database');
                    document.getElementById('voice-status').textContent = '‚ùå';
                    document.getElementById('voice-text').innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 10px; color: #dc3545;">Product Not Found</div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 15px;">
                                Barcode: ${barcode}<br><br>
                                This product isn't in our database yet.<br>
                                Try using Voice or Manual entry instead.
                            </div>
                        </div>
                    `;

                    const logBtn = document.getElementById('voice-button');
                    logBtn.style.display = 'block';
                    logBtn.textContent = 'Try Manual Entry';
                    logBtn.style.background = '#6c757d';

                    const newLogBtn = logBtn.cloneNode(true);
                    logBtn.parentNode.replaceChild(newLogBtn, logBtn);

                    newLogBtn.onclick = () => {
                        closeVoiceModal();
                        showSmartEntry();
                        showManualEntry();
                    };
                }

            } catch (error) {
                console.error('üîç Search error:', error);
                document.getElementById('voice-status').textContent = '‚ùå';
                document.getElementById('voice-text').textContent = 'Error searching for product. Please try again or use Manual entry.';

                const logBtn = document.getElementById('voice-button');
                logBtn.style.display = 'block';
                logBtn.textContent = 'Close';
                logBtn.style.background = '#6c757d';

                const newLogBtn = logBtn.cloneNode(true);
                logBtn.parentNode.replaceChild(newLogBtn, logBtn);
                newLogBtn.onclick = closeVoiceModal;
            }
        }

        function logFood(food) {
            console.log('üçî Logging food:', food);
            const today = getLocalDateString();

            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');

            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], water: 0, totalCalories: 0 };
            }

            const meal = {
                name: food.name,
                calories: food.calories || 0,
                protein: food.protein || 0,
                carbs: food.carbs || 0,
                fat: food.fat || 0,
                sugar: food.sugar || 0,
                time: new Date().toISOString(),
                fromMealPlan: false
            };

            loggedMeals[today].meals.push(meal);
            loggedMeals[today].totalCalories = (loggedMeals[today].totalCalories || 0) + meal.calories;
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            console.log('‚úÖ Food logged successfully');

            // Update the UI without reloading
            syncWithHomePage();
            loadTodaysMeals();
        }

        function closeVoiceModal() {
            document.getElementById('voice-modal').style.display = 'none';

            // Properly stop and clear recognition
            if (recognition) {
                try {
                    recognition.stop();
                    recognition.abort();
                } catch (e) {
                    console.log('Error stopping recognition:', e);
                }
            }
            isRecording = false;

            // Reset modal state
            document.getElementById('voice-text').textContent = 'Click the microphone to start speaking...';
            document.getElementById('voice-status').textContent = 'üé§';
            document.getElementById('food-results').innerHTML = '';

            // CRITICAL: Reset the button to original onclick handler
            const voiceBtn = document.getElementById('voice-button');
            const newBtn = voiceBtn.cloneNode(true);
            newBtn.textContent = 'Start Recording';
            newBtn.style.background = '#FF6B6B';
            newBtn.onclick = toggleVoiceRecording;
            voiceBtn.parentNode.replaceChild(newBtn, voiceBtn);
            newBtn.id = 'voice-button';
        }
        
        // Search food from voice input using AI
        async function searchFoodByVoice(query) {
            try {
                console.log('üéôÔ∏è Processing voice input:', query);

                if (!query || query.trim().length < 2) {
                    document.getElementById('voice-text').textContent = 'Please say something about food you ate.';
                    document.getElementById('voice-button').textContent = 'Start Recording';
                    document.getElementById('voice-button').style.background = '#FF6B6B';
                    document.getElementById('voice-status').textContent = 'üé§';
                    return;
                }

                const results = await parseWithAI(query);
                console.log('ü§ñ AI returned:', results);

                if (!results || results.length === 0) {
                    document.getElementById('voice-text').textContent = 'No food found. Try describing what you ate more clearly.';
                    document.getElementById('voice-button').textContent = 'Start Recording';
                    document.getElementById('voice-button').style.background = '#FF6B6B';
                    document.getElementById('voice-status').textContent = 'üé§';
                    return;
                }

                // Combine duplicate items into single items with quantities
                const combinedResults = {};
                results.forEach(food => {
                    // Normalize the food name (lowercase, trim)
                    const normalizedName = food.name.toLowerCase().trim();

                    if (combinedResults[normalizedName]) {
                        // Add to existing quantity
                        combinedResults[normalizedName].quantity += (food.quantity || 1);
                    } else {
                        // Create new entry
                        combinedResults[normalizedName] = {
                            name: food.name, // Keep original casing
                            calories: food.calories,
                            protein: food.protein,
                            carbs: food.carbs || 0,
                            fat: food.fat || 0,
                            sugar: food.sugar || 0,
                            quantity: food.quantity || 1
                        };
                    }
                });

                // Convert back to array
                const finalResults = Object.values(combinedResults);
                console.log('üîÄ Combined results:', finalResults);
                
                // Show results in voice modal for confirmation
                document.getElementById('voice-text').innerHTML = '';
                document.getElementById('voice-status').textContent = '‚úÖ';

                const foodListHtml = finalResults.map((food, idx) => `
                    <div style="text-align: left; padding: 10px; margin: 5px 0; background: white; border-radius: 8px;">
                        <label style="display: flex; align-items: flex-start; cursor: pointer; width: 100%;">
                            <input type="checkbox" checked class="food-checkbox" data-food-index="${idx}"
                                   data-food-name="${food.name.replace(/"/g, '&quot;')}"
                                   data-food-calories="${food.calories}"
                                   data-food-protein="${food.protein}"
                                   data-food-carbs="${food.carbs || 0}"
                                   data-food-fat="${food.fat || 0}"
                                   data-food-sugar="${food.sugar || 0}"
                                   style="margin-right: 10px; margin-top: 3px; width: 20px; height: 20px; flex-shrink: 0;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${food.name}</div>
                                <div style="font-size: 12px; color: #666; margin: 4px 0;">${food.calories} cal | ${food.protein}g protein</div>
                                <div style="display: flex; align-items: center; gap: 5px; margin-top: 6px;">
                                    <label style="font-size: 11px; color: #666;">Qty:</label>
                                    <input type="number" class="food-quantity" data-food-index="${idx}" value="${food.quantity || 1}" min="0.25" step="0.25"
                                           style="width: 60px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;"
                                           onclick="event.stopPropagation();">
                                </div>
                            </div>
                        </label>
                    </div>
                `).join('');

                document.getElementById('voice-text').innerHTML = `
                    <div id="food-confirmation-list" style="text-align: left;">
                        <div style="font-weight: bold; margin-bottom: 15px;">Found ${finalResults.length} items:</div>
                        ${foodListHtml}
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee;">
                            <label style="font-weight: bold; margin-bottom: 8px; display: block;">Which meal?</label>
                            <select id="meal-type-select" style="width: 100%; padding: 10px; border: 2px solid var(--primary); border-radius: 8px; font-size: 14px;">
                                <option value="breakfast">üåÖ Breakfast</option>
                                <option value="lunch">‚òÄÔ∏è Lunch</option>
                                <option value="dinner">üåô Dinner</option>
                                <option value="snack">üçø Snack</option>
                            </select>
                        </div>
                    </div>
                `;

                const logBtn = document.getElementById('voice-button');
                logBtn.textContent = 'Log Selected Foods';
                logBtn.style.background = '#28a745';

                // Remove old event listener by cloning the button
                const newLogBtn = logBtn.cloneNode(true);
                newLogBtn.id = 'voice-button'; // IMPORTANT: Maintain the ID!
                logBtn.parentNode.replaceChild(newLogBtn, logBtn);

                // Add fresh event listener
                newLogBtn.onclick = () => {
                    // Get meal type
                    const mealType = document.getElementById('meal-type-select')?.value || 'snack';

                    // Get checked items with quantities (ONLY from voice modal)
                    const voiceModal = document.getElementById('voice-modal');
                    const checkboxes = voiceModal.querySelectorAll('.food-checkbox');
                    const selectedFoods = [];

                    console.log('Voice log button clicked, found checkboxes:', checkboxes.length);

                    checkboxes.forEach((cb) => {
                        if (cb.checked) {
                            const idx = parseInt(cb.dataset.foodIndex);
                            const quantityInput = document.querySelector(`.food-quantity[data-food-index="${idx}"]`);
                            const quantity = parseFloat(quantityInput.value) || 1;

                            // Get food data from data attributes
                            const foodName = cb.dataset.foodName;
                            const calories = parseFloat(cb.dataset.foodCalories);
                            const protein = parseFloat(cb.dataset.foodProtein);
                            const carbs = parseFloat(cb.dataset.foodCarbs);
                            const fat = parseFloat(cb.dataset.foodFat);
                            const sugar = parseFloat(cb.dataset.foodSugar) || 0;

                            // Build food object with quantity multiplied
                            const foodToLog = {
                                name: quantity !== 1 ? `${quantity}x ${foodName}` : foodName,
                                calories: Math.round(calories * quantity),
                                protein: Math.round(protein * quantity),
                                carbs: Math.round(carbs * quantity),
                                fat: Math.round(fat * quantity),
                                sugar: Math.round(sugar * quantity),
                                meal: mealType
                            };
                            selectedFoods.push(foodToLog);
                        }
                    });

                    if (selectedFoods.length > 0) {
                        // Log the selected foods
                        selectedFoods.forEach(food => {
                            logFood(food);
                        });

                        // Show success message
                        const mealEmoji = {
                            'breakfast': 'üåÖ',
                            'lunch': '‚òÄÔ∏è',
                            'dinner': 'üåô',
                            'snack': 'üçø'
                        }[mealType] || 'üç¥';

                        document.getElementById('voice-text').textContent = `Logged ${selectedFoods.length} food(s) to ${mealEmoji} ${mealType}!`;
                        document.getElementById('voice-status').textContent = 'üéâ';

                        // Close modal after short delay
                        setTimeout(() => {
                            closeVoiceModal();
                        }, 800);
                    } else {
                        alert('Please select at least one food item');
                    }
                };

            } catch (error) {
                console.error('‚ùå Voice processing error:', error);
                document.getElementById('voice-text').textContent = `Error: ${error.message}. Try typing your food instead.`;
                document.getElementById('voice-button').textContent = 'Try Again';
                document.getElementById('voice-button').style.background = '#FF6B6B';
                document.getElementById('voice-status').textContent = '‚ùå';
                
                // Auto-close modal after error
                setTimeout(() => {
                    closeVoiceModal();
                }, 3000);
            }
        }
        
        // AI-Powered Food Parsing using Claude API
        async function parseWithAI(query) {
            try {
                console.log('ü§ñ AI parsing food:', query);

                // Show loading state
                document.getElementById('voice-text').textContent = `Analyzing: "${query}"...`;

                console.log('üì° Making API call to /api/ai-food-parser...');

                const response = await fetch('https://fuelfire-app.vercel.app/api/ai-food-parser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });

                console.log('üì° API response status:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üì° API response data:', data);

                if (data.success) {
                    console.log(`üçî AI found ${data.foods.length} foods from ${data.source}`);
                    if (data.message) {
                        console.log('üìù', data.message);
                    }

                    // Log sugar content to verify it's being returned
                    data.foods.forEach(food => {
                        console.log(`üç≠ ${food.name}: ${food.sugar || 0}g sugar`);
                    });

                    // Update the voice text to show what was found
                    if (data.foods.length > 1) {
                        const foodNames = data.foods.map(f => f.name).join(' + ');
                        document.getElementById('voice-text').textContent = `Found: ${foodNames}`;
                    } else if (data.foods.length === 1) {
                        document.getElementById('voice-text').textContent = `Found: ${data.foods[0].name}`;
                    }

                    return data.foods;
                } else {
                    throw new Error(data.error || data.message || 'Parsing failed');
                }

            } catch (error) {
                console.error('‚ùå AI food parsing error:', error);
                document.getElementById('voice-text').textContent = `AI Error: ${error.message}`;

                // Reset button
                document.getElementById('voice-button').textContent = 'Start Recording';
                document.getElementById('voice-button').style.background = '#FF6B6B';
                document.getElementById('voice-status').textContent = 'üé§';

                return [];
            }
        }
        
        // USDA API Search (fallback)
        async function searchUSDA(query) {
            try {
                console.log('üîç Searching USDA for:', query);
                
                const response = await fetch('/api/usda-food-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Found ${data.foods.length} foods from ${data.source}`);
                    if (data.message) {
                        console.log('üìù', data.message);
                    }
                    return data.foods;
                } else {
                    throw new Error(data.error || 'Search failed');
                }
                
            } catch (error) {
                console.error('USDA search error:', error);
                
                // Final fallback to basic estimation
                return [{
                    name: `${query} (estimated)`,
                    calories: 350,
                    protein: 15,
                    carbs: 30,
                    fat: 15,
                    source: 'estimated'
                }];
            }
        }
        
        // Display food search results
        function displayFoodResults(foods, source) {
            const resultsDiv = document.getElementById(source === 'voice' ? 'food-results' : 'search-results');

            if (foods.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #666;">No foods found</p>';
                return;
            }

            // Show all foods with checkboxes and quantity
            let html = `<div style="font-weight: bold; margin-bottom: 10px; color: #4CAF50;">ü§ñ Found ${foods.length} item(s):</div>`;

            // Add checkboxes for each food item with quantity input
            html += '<div style="margin-bottom: 15px;">';
            foods.forEach((food, index) => {
                html += `
                    <div style="background: #f8f9ff; padding: 12px; border-radius: 10px; margin-bottom: 8px;">
                        <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                            <input type="checkbox" class="manual-food-check" data-index="${index}"
                                   data-food-name="${food.name.replace(/"/g, '&quot;')}"
                                   data-food-calories="${food.calories}"
                                   data-food-protein="${food.protein || 0}"
                                   data-food-carbs="${food.carbs || 0}"
                                   data-food-fat="${food.fat || 0}"
                                   data-food-sugar="${food.sugar || 0}"
                                   checked style="width: 20px; height: 20px; margin-top: 3px; flex-shrink: 0;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${food.name}</div>
                                <div style="font-size: 14px; color: #666;">${food.calories} cal | P: ${food.protein || 0}g | C: ${food.carbs || 0}g | F: ${food.fat || 0}g</div>
                                ${food.serving ? `<div style="font-size: 12px; color: #999;">${food.serving}</div>` : ''}
                                <div style="margin-top: 8px; display: flex; align-items: center; gap: 5px;">
                                    <label style="font-size: 12px; color: #666;">Qty:</label>
                                    <input type="number" class="manual-food-quantity" data-index="${index}" value="1" min="0.25" step="0.25"
                                           style="width: 60px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;"
                                           onclick="event.stopPropagation();">
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            });
            html += '</div>';

            // Add meal selector
            html += `
                <div style="background: white; padding: 12px; border-radius: 10px; margin-bottom: 12px;">
                    <label style="font-weight: bold; margin-bottom: 8px; display: block;">Which meal?</label>
                    <select id="manual-meal-select" style="width: 100%; padding: 10px; border: 2px solid var(--primary); border-radius: 8px; font-size: 14px;">
                        <option value="breakfast">üåÖ Breakfast</option>
                        <option value="lunch">‚òÄÔ∏è Lunch</option>
                        <option value="dinner">üåô Dinner</option>
                        <option value="snack">üçø Snack</option>
                    </select>
                </div>
            `;

            // Show "Log Selected" button
            html += `
                <div style="background: #4CAF50; color: white; padding: 12px; border-radius: 10px; margin-bottom: 12px; cursor: pointer; text-align: center;"
                     onclick="logSelectedFoods()">
                    <div style="font-weight: bold;">‚úÖ Log Selected Foods</div>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }
        
        // Update total when checkboxes change
        function updateSelectedTotal() {
            if (!window.currentFoods) return;
            
            let total = 0;
            window.currentFoods.forEach((food, index) => {
                const checkbox = document.getElementById(`food-check-${index}`);
                if (checkbox && checkbox.checked) {
                    total += food.calories;
                }
            });
            
            const totalDiv = document.getElementById('selected-total');
            if (totalDiv) {
                totalDiv.textContent = `Total: ${total} calories`;
            }
        }
        
        // Log selected foods
        function logSelectedFoods() {
            try {
                // Get meal type from selector
                const mealType = document.getElementById('manual-meal-select')?.value || 'snack';

                // Get checked items with quantities
                const checkboxes = document.querySelectorAll('.manual-food-check');
                const selectedFoods = [];

                checkboxes.forEach((cb) => {
                    if (cb.checked) {
                        const index = cb.dataset.index;
                        const quantityInput = document.querySelector(`.manual-food-quantity[data-index="${index}"]`);
                        const quantity = parseFloat(quantityInput?.value) || 1;

                        // Get food data from data attributes
                        const foodName = cb.dataset.foodName;
                        const calories = parseFloat(cb.dataset.foodCalories);
                        const protein = parseFloat(cb.dataset.foodProtein);
                        const carbs = parseFloat(cb.dataset.foodCarbs);
                        const fat = parseFloat(cb.dataset.foodFat);
                        const sugar = parseFloat(cb.dataset.foodSugar) || 0;

                        selectedFoods.push({
                            name: quantity !== 1 ? `${quantity}x ${foodName}` : foodName,
                            calories: Math.round(calories * quantity),
                            protein: Math.round(protein * quantity),
                            carbs: Math.round(carbs * quantity),
                            fat: Math.round(fat * quantity),
                            sugar: Math.round(sugar * quantity),
                            meal: mealType
                        });
                    }
                });

                if (selectedFoods.length === 0) {
                    alert('Please select at least one food item');
                    return;
                }
            
            const today = getLocalDateString();
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }
            
            let totalCalories = 0;
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFat = 0;
            
            selectedFoods.forEach(food => {
                const meal = {
                    name: food.name,
                    calories: food.calories,
                    protein: food.protein || 0,
                    carbs: food.carbs || 0,
                    fat: food.fat || 0,
                    type: food.meal,
                    time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                };
                
                loggedMeals[today].meals.push(meal);
                totalCalories += food.calories;
                totalProtein += food.protein || 0;
                totalCarbs += food.carbs || 0;
                totalFat += food.fat || 0;
            });
            
            loggedMeals[today].totalCalories += totalCalories;
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            
            // Update UI and sync
            syncWithHomePage();
            updateTodayProgress();
            loadTodaysMeals();
            loadQuickAdds();

            // Close the voice modal if it's open
            if (window.currentSource === 'voice') {
                closeVoiceModal();
            }

            // Clear results and close the smart entry modal
            document.getElementById('food-results').innerHTML = '';
            document.getElementById('search-results').innerHTML = '';
            document.getElementById('smart-entry-modal').style.display = 'none';

            alert(`‚úÖ Logged ${selectedFoods.length} items (${totalCalories} calories)`);

            // Clear the current foods after successful logging
            window.currentFoods = null;
            window.currentSource = null;
            
            } catch (error) {
                console.error('Error logging foods:', error);
                alert('There was an error logging your foods. Please try again.');
                // Don't clear currentFoods on error so user can retry
            }
        }
        
        // Log all current foods (simplified for onclick) - DEPRECATED but kept for compatibility
        function logAllCurrentFoods() {
            if (!window.currentFoods || !window.currentSource) {
                alert('Error: No foods to log');
                return;
            }
            
            const mealType = prompt('Log all foods as:\n1. Breakfast\n2. Lunch\n3. Dinner\n4. Snack\n\nEnter number (1-4):');
            const types = ['', 'breakfast', 'lunch', 'dinner', 'snack'];
            const type = types[parseInt(mealType)] || 'snack';
            
            const today = getLocalDateString();
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }
            
            let totalCalories = 0;
            let totalProtein = 0;
            let totalCarbs = 0; 
            let totalFat = 0;
            let totalSugar = 0;
            
            // Log each food
            window.currentFoods.forEach(food => {
                const mealEntry = {
                    name: food.name,
                    type: type,
                    calories: food.calories,
                    protein: food.protein || 0,
                    carbs: food.carbs || 0,
                    fat: food.fat || 0,
                    sugar: food.sugar || 0,
                    time: new Date().toISOString(),
                    source: window.currentSource,
                    serving: food.serving || '1 serving'
                };

                console.log('üíæ Logging meal:', mealEntry);
                loggedMeals[today].meals.push(mealEntry);

                totalCalories += food.calories;
                totalProtein += food.protein || 0;
                totalCarbs += food.carbs || 0;
                totalFat += food.fat || 0;
                totalSugar += food.sugar || 0;
            });
            
            loggedMeals[today].totalCalories += totalCalories;
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            syncWithHomePage();
            
            // Close modals and refresh
            if (window.currentSource === 'voice') {
                closeVoiceModal();
            }
            if (window.currentSource === 'search') {
                closeSmartEntry();
            }
            
            // Reset the UI properly after logging
            updateTodayProgress();
            loadTodaysMeals();
            loadQuickAdds();
            
            const foodNames = window.currentFoods.map(f => f.name).join('\n‚Ä¢ ');
            alert(`‚úÖ All foods logged as ${type}!\n\n‚Ä¢ ${foodNames}\n\nüìä Total: ${totalCalories} calories\nü•© ${totalProtein}g protein\nüçû ${totalCarbs}g carbs\nü•ë ${totalFat}g fat\nüç≠ ${totalSugar}g sugar`);
            
            // Clear globals
            window.currentFoods = null;
            window.currentSource = null;
        }
        
        // Select and log food
        function selectFood(name, calories, protein, carbs, fat, sugar, source) {
            const mealType = prompt('Log as:\n1. Breakfast\n2. Lunch\n3. Dinner\n4. Snack\n\nEnter number (1-4):');
            const types = ['', 'breakfast', 'lunch', 'dinner', 'snack'];
            const type = types[parseInt(mealType)] || 'snack';
            
            // Log the food
            const today = getLocalDateString();
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }
            
            loggedMeals[today].meals.push({
                name: name,
                type: type,
                calories: calories,
                protein: protein,
                carbs: carbs,
                fat: fat,
                sugar: sugar || 0,
                time: new Date().toISOString(),
                source: source
            });
            
            loggedMeals[today].totalCalories += calories;
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            syncWithHomePage();
            
            // Close modal and refresh
            if (source === 'voice') closeVoiceModal();
            if (source === 'search') closeSmartEntry();
            
            loadTodaysMeals();
            loadQuickAdds();
            
            alert(`‚úÖ ${name} logged!\n\nüìä ${calories} calories\nü•© ${protein}g protein\nüçû ${carbs}g carbs\nü•ë ${fat}g fat\nüç≠ ${sugar || 0}g sugar`);
        }
        
        // Smart Entry
        function showSmartEntry() {
            document.getElementById('smart-entry-modal').style.display = 'block';
            document.getElementById('smart-search').focus();
        }
        
        function closeSmartEntry() {
            document.getElementById('smart-entry-modal').style.display = 'none';
            document.getElementById('smart-search').value = '';
            document.getElementById('search-results').innerHTML = '';
        }
        
        async function searchFood(query) {
            if (!query || query.length < 2) {
                document.getElementById('search-results').innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Enter at least 2 characters to search</div>';
                return;
            }
            
            // Show loading
            document.getElementById('search-results').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ü§ñ AI analyzing...</div>';
            
            // Always use AI for better results
            const results = await parseWithAI(query);
            
            displayFoodResults(results, 'search');
        }
        
        // Tab switching functions
        function showAISearch() {
            console.log('üîÑ Switching to AI Search tab');

            const aiContent = document.getElementById('ai-search-content');
            const manualContent = document.getElementById('manual-entry-content');

            // Show AI search with !important via cssText + reset position
            aiContent.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; pointer-events: auto !important; position: relative !important; left: 0 !important; top: 0 !important;';

            // Hide manual entry
            manualContent.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';

            // Update tab buttons
            document.getElementById('ai-search-tab').style.background = 'var(--primary)';
            document.getElementById('ai-search-tab').style.color = 'white';
            document.getElementById('manual-entry-tab').style.background = '#e0e0e0';
            document.getElementById('manual-entry-tab').style.color = '#666';

            // Re-show search results div when switching back to AI
            const searchResults = document.getElementById('search-results');
            if (searchResults) {
                searchResults.style.cssText = 'display: block !important;';
            }

            console.log('‚úÖ AI Search tab active');
        }
        
        function showManualEntry() {
            console.log('üîÑ Switching to Manual Entry tab');

            const aiContent = document.getElementById('ai-search-content');
            const manualContent = document.getElementById('manual-entry-content');

            // Hide AI search completely with !important via cssText + physically move off screen
            aiContent.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; position: absolute !important; left: -99999px !important; top: -99999px !important;';

            // Show manual entry
            manualContent.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';

            // Update tab buttons
            document.getElementById('manual-entry-tab').style.background = 'var(--primary)';
            document.getElementById('manual-entry-tab').style.color = 'white';
            document.getElementById('ai-search-tab').style.background = '#e0e0e0';
            document.getElementById('ai-search-tab').style.color = '#666';

            // Clear AI search results
            const searchResults = document.getElementById('search-results');
            if (searchResults) {
                searchResults.innerHTML = '';
                searchResults.style.cssText = 'display: none !important;';
            }

            // Clear the search input
            const searchInput = document.getElementById('smart-search');
            if (searchInput) {
                searchInput.value = '';
            }

            console.log('‚úÖ Manual Entry tab active, AI content hidden');
        }
        
        // Load quick adds from history
        function loadQuickAdds() {
            try {
                const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
                const foodCounts = {};
            
            // Count frequency of foods
            Object.values(loggedMeals).forEach(day => {
                day.meals?.forEach(meal => {
                    const key = `${meal.name}|${meal.calories}|${meal.protein}|${meal.carbs}|${meal.fat}`;
                    foodCounts[key] = (foodCounts[key] || 0) + 1;
                });
            });
            
            // Get top 5 most frequent
            const topFoods = Object.entries(foodCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const quickAddsDiv = document.getElementById('quick-adds');
            if (topFoods.length === 0) {
                quickAddsDiv.innerHTML = '<div style="color: rgba(255,255,255,0.6); font-size: 12px;">Log foods to see quick adds</div>';
                return;
            }
            
            quickAddsDiv.innerHTML = topFoods.map(([foodData, count]) => {
                const [name, calories, protein, carbs, fat] = foodData.split('|');
                return `
                    <button onclick="selectFood('${name}', ${calories}, ${protein}, ${carbs}, ${fat}, 'quick')" 
                            style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); 
                                   padding: 8px 12px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer;">
                        ${name} (${calories}cal)
                    </button>
                `;
            }).join('');
            
            } catch (error) {
                console.error('Error in loadQuickAdds:', error);
                // Don't throw error, just log it
            }
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        
        function goToPage(page) {
            window.location.href = page;
        }
        
        function goToScreen(page, screen) {
            // Navigate to index.html with a query parameter for the screen
            window.location.href = `${page}?screen=${screen}`;
        }
        
        // Update macro display with progress bars
        function updateMacroDisplay(macroType, consumed, target) {
            // Update consumed/target values
            document.getElementById(`${macroType}-consumed`).textContent = Math.round(consumed);
            document.getElementById(`${macroType}-target`).textContent = Math.round(target);
            
            // Calculate percentage
            const percentage = Math.min((consumed / target) * 100, 100);
            const percentageRounded = Math.round((consumed / target) * 100);
            
            // Update progress bar
            document.getElementById(`${macroType}-bar`).style.width = `${percentage}%`;
            
            // Update percentage display if it exists (not for sugar)
            const percentElement = document.getElementById(`${macroType}-percent`);
            if (percentElement) {
                percentElement.textContent = `${percentageRounded}%`;
            }
            
            // Special handling for sugar
            if (macroType === 'sugar') {
                const statusElement = document.getElementById('sugar-status');
                if (consumed > target) {
                    // Over limit - red
                    document.getElementById('sugar-bar').style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
                    statusElement.textContent = 'Over Limit';
                    statusElement.style.color = '#e74c3c';
                } else {
                    // Within limit - blue
                    document.getElementById('sugar-bar').style.background = 'linear-gradient(90deg, #3498db, #2980b9)';
                    statusElement.textContent = 'Within Limit';
                    statusElement.style.color = '#3498db';
                }
                return; // Skip the general color coding below
            }
            
            // Color coding for progress bars based on completion
            const bar = document.getElementById(`${macroType}-bar`);
            if (percentageRounded >= 100) {
                // Completed - use brighter colors
                if (macroType === 'protein') bar.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
                if (macroType === 'carbs') bar.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
                if (macroType === 'fat') bar.style.background = 'linear-gradient(90deg, #27ae60, #229954)';
            } else if (percentageRounded >= 80) {
                // Near completion - slightly dimmed
                if (macroType === 'protein') bar.style.background = 'linear-gradient(90deg, #ec7063, #d5616a)';
                if (macroType === 'carbs') bar.style.background = 'linear-gradient(90deg, #f7a83b, #e89550)';
                if (macroType === 'fat') bar.style.background = 'linear-gradient(90deg, #48c774, #3a9960)';
            } else {
                // Lower completion - dimmed colors
                if (macroType === 'protein') bar.style.background = 'linear-gradient(90deg, #fadbd8, #f5c6cb)';
                if (macroType === 'carbs') bar.style.background = 'linear-gradient(90deg, #fdebd0, #fce4b6)';
                if (macroType === 'fat') bar.style.background = 'linear-gradient(90deg, #d5f4e6, #c8e6c9)';
            }
        }
        
        function loadTodaysMeals() {
            try {
                const today = getLocalDateString();
                const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
                const todayData = loggedMeals[today] || { meals: [], totalCalories: 0 };

                console.log('üìÖ Loading meals for:', today);
                console.log('üìä Today\'s data:', todayData);
                console.log('üçî Meal count:', todayData.meals.length);
            
            // Get user's targets from nutrition goals (set in Goals & Progress page)
            const nutritionGoals = JSON.parse(localStorage.getItem('fuelfire_nutrition_goals') || '{}');
            const userProfile = JSON.parse(localStorage.getItem('fuelfire_user_profile') || '{}');
            const recentDietGoals = JSON.parse(localStorage.getItem('fuelfire_recent_diet_goals') || '{}');

            // Calculate targets - prioritize nutrition goals, then user profile, then diet quiz, then defaults
            const calorieTarget = nutritionGoals.calories || userProfile.calorieTarget || recentDietGoals.calorieTarget || 2000;
            const proteinTarget = nutritionGoals.protein || userProfile.proteinTarget || recentDietGoals.proteinTarget || 150;
            const carbsTarget = nutritionGoals.carbs || userProfile.carbsTarget || recentDietGoals.carbsTarget || 225;
            const fatTarget = nutritionGoals.fat || userProfile.fatTarget || recentDietGoals.fatTarget || 67;
            
            // Calculate consumed macros
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFat = 0;
            let totalSugar = 0;
            
            todayData.meals.forEach(meal => {
                totalProtein += meal.protein || 0;
                totalCarbs += meal.carbs || 0;
                totalFat += meal.fat || 0;
                totalSugar += meal.sugar || 0;
            });
            
            // Get active calories burned (Apple Health + Manual + Workouts)
            const activeCalories = getTotalActiveCalories();

            // Calculate adjusted target (base + active burned)
            const adjustedTarget = calorieTarget + activeCalories;

            // Calculate remaining calories (can be negative for deficit)
            const remaining = adjustedTarget - (todayData.totalCalories || 0);

            // Update calorie summary displays
            document.getElementById('calories-today').textContent = Math.round(todayData.totalCalories || 0).toLocaleString();
            document.getElementById('calorie-target').textContent = calorieTarget.toLocaleString();
            document.getElementById('active-burned').textContent = activeCalories.toLocaleString();
            document.getElementById('adjusted-target').textContent = adjustedTarget.toLocaleString();

            // Show deficit (negative) or surplus (positive)
            const remainingEl = document.getElementById('calories-remaining');
            if (remaining < 0) {
                remainingEl.textContent = Math.abs(remaining).toLocaleString() + ' deficit';
                remainingEl.style.color = '#4CAF50'; // Green for deficit (good for weight loss)
            } else if (remaining > 0) {
                remainingEl.textContent = remaining.toLocaleString() + ' remaining';
                remainingEl.style.color = '#2196F3'; // Blue for remaining
            } else {
                remainingEl.textContent = '0 (balanced)';
                remainingEl.style.color = '#666';
            }
            
            // Set sugar target from nutrition goals or WHO recommendation (max 25g/day for adults)
            const sugarTarget = nutritionGoals.sugar || 25;
            
            // Update macro tracking
            updateMacroDisplay('protein', totalProtein, proteinTarget);
            updateMacroDisplay('carbs', totalCarbs, carbsTarget);
            updateMacroDisplay('fat', totalFat, fatTarget);
            updateMacroDisplay('sugar', totalSugar, sugarTarget);
            
            // Organize meals by type
            const mealsByType = {
                breakfast: [],
                lunch: [], 
                dinner: [],
                snack: []
            };
            
            todayData.meals.forEach((meal, index) => {
                const mealType = meal.type || 'snack';
                mealsByType[mealType].push({...meal, originalIndex: index});
            });
            
            // Update meals list with organized sections
            const mealsDiv = document.getElementById('today-meals');
            if (todayData.meals.length === 0) {
                mealsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No meals logged yet today</p>';
            } else {
                let mealsHTML = '';
                
                // Breakfast Section
                if (mealsByType.breakfast.length > 0) {
                    const breakfastCalories = mealsByType.breakfast.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                    const breakfastProtein = mealsByType.breakfast.reduce((sum, meal) => sum + (meal.protein || 0), 0);
                    const breakfastCarbs = mealsByType.breakfast.reduce((sum, meal) => sum + (meal.carbs || 0), 0);
                    const breakfastFat = mealsByType.breakfast.reduce((sum, meal) => sum + (meal.fat || 0), 0);
                    
                    mealsHTML += `
                        <div style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">üåÖ Breakfast</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${breakfastCalories}</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Calories</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(breakfastProtein)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Protein</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(breakfastCarbs)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Carbs</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(breakfastFat)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Fat</div>
                                </div>
                            </div>
                    `;
                    
                    mealsByType.breakfast.forEach((meal) => {
                        const time = new Date(meal.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        mealsHTML += `
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">${meal.name}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">${time} ${meal.fromMealPlan ? '‚Ä¢ From meal plan' : ''}</div>
                                        <div style="font-size: 13px; margin-top: 5px;">
                                            üìä ${meal.calories || 0} cal ‚Ä¢ ü•© ${Math.round(meal.protein || 0)}g protein ‚Ä¢ üçû ${Math.round(meal.carbs || 0)}g carbs ‚Ä¢ ü•ë ${Math.round(meal.fat || 0)}g fat ‚Ä¢ üç≠ ${Math.round(meal.sugar || 0)}g sugar
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 5px; margin-left: 10px;">
                                        <button onclick="editMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">‚úèÔ∏è</button>
                                        <button onclick="removeMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">√ó</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    mealsHTML += '</div>';
                }
                
                // Lunch Section
                if (mealsByType.lunch.length > 0) {
                    const lunchCalories = mealsByType.lunch.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                    const lunchProtein = mealsByType.lunch.reduce((sum, meal) => sum + (meal.protein || 0), 0);
                    const lunchCarbs = mealsByType.lunch.reduce((sum, meal) => sum + (meal.carbs || 0), 0);
                    const lunchFat = mealsByType.lunch.reduce((sum, meal) => sum + (meal.fat || 0), 0);
                    
                    mealsHTML += `
                        <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">‚òÄÔ∏è Lunch</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${lunchCalories}</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Calories</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(lunchProtein)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Protein</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(lunchCarbs)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Carbs</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(lunchFat)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Fat</div>
                                </div>
                            </div>
                    `;
                    
                    mealsByType.lunch.forEach((meal) => {
                        const time = new Date(meal.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        mealsHTML += `
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">${meal.name}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">${time} ${meal.fromMealPlan ? '‚Ä¢ From meal plan' : ''}</div>
                                        <div style="font-size: 13px; margin-top: 5px;">
                                            üìä ${meal.calories || 0} cal ‚Ä¢ ü•© ${Math.round(meal.protein || 0)}g protein ‚Ä¢ üçû ${Math.round(meal.carbs || 0)}g carbs ‚Ä¢ ü•ë ${Math.round(meal.fat || 0)}g fat ‚Ä¢ üç≠ ${Math.round(meal.sugar || 0)}g sugar
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 5px; margin-left: 10px;">
                                        <button onclick="editMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">‚úèÔ∏è</button>
                                        <button onclick="removeMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">√ó</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    mealsHTML += '</div>';
                }
                
                // Dinner Section
                if (mealsByType.dinner.length > 0) {
                    const dinnerCalories = mealsByType.dinner.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                    const dinnerProtein = mealsByType.dinner.reduce((sum, meal) => sum + (meal.protein || 0), 0);
                    const dinnerCarbs = mealsByType.dinner.reduce((sum, meal) => sum + (meal.carbs || 0), 0);
                    const dinnerFat = mealsByType.dinner.reduce((sum, meal) => sum + (meal.fat || 0), 0);
                    
                    mealsHTML += `
                        <div style="background: linear-gradient(135deg, #FF6B6B, #FF5722); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">üåô Dinner</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${dinnerCalories}</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Calories</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(dinnerProtein)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Protein</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(dinnerCarbs)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Carbs</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(dinnerFat)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Fat</div>
                                </div>
                            </div>
                    `;
                    
                    mealsByType.dinner.forEach((meal) => {
                        const time = new Date(meal.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        mealsHTML += `
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">${meal.name}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">${time} ${meal.fromMealPlan ? '‚Ä¢ From meal plan' : ''}</div>
                                        <div style="font-size: 13px; margin-top: 5px;">
                                            üìä ${meal.calories || 0} cal ‚Ä¢ ü•© ${Math.round(meal.protein || 0)}g protein ‚Ä¢ üçû ${Math.round(meal.carbs || 0)}g carbs ‚Ä¢ ü•ë ${Math.round(meal.fat || 0)}g fat ‚Ä¢ üç≠ ${Math.round(meal.sugar || 0)}g sugar
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 5px; margin-left: 10px;">
                                        <button onclick="editMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">‚úèÔ∏è</button>
                                        <button onclick="removeMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">√ó</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    mealsHTML += '</div>';
                }
                
                // Snacks Section
                if (mealsByType.snack.length > 0) {
                    const snackCalories = mealsByType.snack.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                    const snackProtein = mealsByType.snack.reduce((sum, meal) => sum + (meal.protein || 0), 0);
                    const snackCarbs = mealsByType.snack.reduce((sum, meal) => sum + (meal.carbs || 0), 0);
                    const snackFat = mealsByType.snack.reduce((sum, meal) => sum + (meal.fat || 0), 0);
                    
                    mealsHTML += `
                        <div style="background: linear-gradient(135deg, #9C27B0, #673AB7); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">üçé Snacks</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${snackCalories}</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Calories</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(snackProtein)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Protein</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(snackCarbs)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Carbs</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(snackFat)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Fat</div>
                                </div>
                            </div>
                    `;
                    
                    mealsByType.snack.forEach((meal) => {
                        const time = new Date(meal.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        mealsHTML += `
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">${meal.name}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">${time} ${meal.fromMealPlan ? '‚Ä¢ From meal plan' : ''}</div>
                                        <div style="font-size: 13px; margin-top: 5px;">
                                            üìä ${meal.calories || 0} cal ‚Ä¢ ü•© ${Math.round(meal.protein || 0)}g protein ‚Ä¢ üçû ${Math.round(meal.carbs || 0)}g carbs ‚Ä¢ ü•ë ${Math.round(meal.fat || 0)}g fat ‚Ä¢ üç≠ ${Math.round(meal.sugar || 0)}g sugar
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 5px; margin-left: 10px;">
                                        <button onclick="editMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">‚úèÔ∏è</button>
                                        <button onclick="removeMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; cursor: pointer;">√ó</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    mealsHTML += '</div>';
                }
                
                mealsDiv.innerHTML = mealsHTML;
                console.log('‚úÖ Updated meals display with HTML length:', mealsHTML.length);
            }

            console.log('üéØ Calories display updated:', document.getElementById('calories-today').textContent);

            // Load weekly chart
            loadWeeklyChart();

            } catch (error) {
                console.error('Error in loadTodaysMeals:', error, error.stack);
                // Don't throw error, just log it to prevent breaking the UI
            }
        }
        
        function updateTodayProgress() {
            // This function updates the UI to reflect today's progress
            // It's called after logging food to refresh the display
            try {
                const today = getLocalDateString();
                const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
                const todayData = loggedMeals[today] || { meals: [], totalCalories: 0 };

                // Update the calories display
                const caloriesElement = document.getElementById('calories-today');
                if (caloriesElement) {
                    caloriesElement.textContent = Math.round(todayData.totalCalories || 0).toLocaleString();
                }
                
                // Update the progress bar if it exists
                const progressBar = document.querySelector('.progress');
                if (progressBar) {
                    const target = parseInt(document.getElementById('calorie-target')?.textContent || '2000');
                    const progress = Math.min((todayData.totalCalories / target) * 100, 100);
                    progressBar.style.width = progress + '%';
                }
                
            } catch (error) {
                console.error('Error in updateTodayProgress:', error);
            }
        }
        
        function loadWeeklyChart() {
            const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            const chartDiv = document.getElementById('weekly-chart');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            let chartHTML = '';
            const maxCalories = 3000; // Max for chart scaling
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - dayOfWeek + i + 1); // Start from Monday
                const dateStr = date.toISOString().split('T')[0];
                const dayData = loggedMeals[dateStr] || { totalCalories: 0 };
                const height = (dayData.totalCalories / maxCalories) * 100;
                const isToday = dateStr === today.toISOString().split('T')[0];
                
                chartHTML += `
                    <div style="text-align: center; flex: 1;">
                        <div style="height: 100px; display: flex; align-items: flex-end; justify-content: center;">
                            <div style="width: 30px; height: ${height}%; background: ${isToday ? 'var(--gradient-1)' : '#e0e0e0'}; border-radius: 5px 5px 0 0;"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">${days[i]}</div>
                        <div style="font-size: 11px; color: #999;">${dayData.totalCalories}</div>
                    </div>
                `;
            }
            
            chartDiv.innerHTML = chartHTML;
        }
        
        function removeMeal(index) {
            if (confirm('Remove this meal?')) {
                const today = getLocalDateString();
                const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');

                if (loggedMeals[today] && loggedMeals[today].meals[index]) {
                    const removedCalories = loggedMeals[today].meals[index].calories;
                    loggedMeals[today].meals.splice(index, 1);
                    loggedMeals[today].totalCalories -= removedCalories;

                    localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
                    syncWithHomePage();
                    loadTodaysMeals();
                }
            }
        }

        function editMeal(index) {
            const today = getLocalDateString();
            const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');

            if (loggedMeals[today] && loggedMeals[today].meals[index]) {
                const meal = loggedMeals[today].meals[index];

                // Fill in the edit form
                document.getElementById('edit-food-name').value = meal.name || '';
                document.getElementById('edit-calories').value = meal.calories || '';
                document.getElementById('edit-protein').value = meal.protein || '';
                document.getElementById('edit-carbs').value = meal.carbs || '';
                document.getElementById('edit-fat').value = meal.fat || '';
                document.getElementById('edit-sugar').value = meal.sugar || '';
                document.getElementById('edit-meal-index').value = index;

                // Show modal
                document.getElementById('edit-meal-modal').style.display = 'block';
            }
        }

        function saveMealEdit() {
            const today = getLocalDateString();
            const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            const index = parseInt(document.getElementById('edit-meal-index').value);

            if (loggedMeals[today] && loggedMeals[today].meals[index]) {
                const oldCalories = loggedMeals[today].meals[index].calories;

                // Update the meal
                loggedMeals[today].meals[index] = {
                    ...loggedMeals[today].meals[index],
                    name: document.getElementById('edit-food-name').value,
                    calories: parseFloat(document.getElementById('edit-calories').value) || 0,
                    protein: parseFloat(document.getElementById('edit-protein').value) || 0,
                    carbs: parseFloat(document.getElementById('edit-carbs').value) || 0,
                    fat: parseFloat(document.getElementById('edit-fat').value) || 0,
                    sugar: parseFloat(document.getElementById('edit-sugar').value) || 0
                };

                // Recalculate total calories
                loggedMeals[today].totalCalories = loggedMeals[today].meals.reduce((sum, meal) => sum + (meal.calories || 0), 0);

                localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
                syncWithHomePage();
                loadTodaysMeals();
                closeEditMeal();

                alert('Meal updated successfully!');
            }
        }

        function closeEditMeal() {
            document.getElementById('edit-meal-modal').style.display = 'none';
        }
        
        function showManualEntryModal() {
            document.getElementById('manual-entry-modal').style.display = 'block';
            loadSavedMealsToSelect();
            document.getElementById('food-name').focus();
        }

        function hideManualEntryModal() {
            document.getElementById('manual-entry-modal').style.display = 'none';
            clearManualEntryForm();
        }
        
        function clearManualEntryForm() {
            document.getElementById('food-name').value = '';
            document.getElementById('food-calories').value = '';
            document.getElementById('food-protein').value = '';
            document.getElementById('food-carbs').value = '';
            document.getElementById('food-fat').value = '';
            document.getElementById('food-sugar').value = '';
            document.getElementById('save-meal-checkbox').checked = false;
            document.getElementById('saved-meals-select').value = '';
        }
        
        function loadSavedMealsToSelect() {
            const select = document.getElementById('saved-meals-select');
            const savedMeals = JSON.parse(localStorage.getItem('fuelfire_saved_meals') || '[]');
            
            // Clear existing options except first
            select.innerHTML = '<option value="">Select saved meal...</option>';
            
            savedMeals.forEach((meal, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${meal.name} (${meal.calories} cal)`;
                select.appendChild(option);
            });
        }
        
        function loadSavedMeal() {
            const select = document.getElementById('saved-meals-select');
            const selectedIndex = select.value;
            
            if (selectedIndex === '') return;
            
            const savedMeals = JSON.parse(localStorage.getItem('fuelfire_saved_meals') || '[]');
            const meal = savedMeals[selectedIndex];
            
            if (meal) {
                document.getElementById('food-name').value = meal.name;
                document.getElementById('food-calories').value = meal.calories;
                document.getElementById('food-protein').value = meal.protein || 0;
                document.getElementById('food-carbs').value = meal.carbs || 0;
                document.getElementById('food-fat').value = meal.fat || 0;
                document.getElementById('food-sugar').value = meal.sugar || 0;
            }
        }
        
        function addManualFood() {
            const name = document.getElementById('food-name').value;
            const calories = parseInt(document.getElementById('food-calories').value) || 0;
            const protein = parseInt(document.getElementById('food-protein').value) || 0;
            const carbs = parseInt(document.getElementById('food-carbs').value) || 0;
            const fat = parseInt(document.getElementById('food-fat').value) || 0;
            const sugar = parseInt(document.getElementById('food-sugar').value) || 0;
            const shouldSave = document.getElementById('save-meal-checkbox').checked;
            
            if (!name) {
                alert('Please enter a food name');
                return;
            }
            
            const foodItem = {
                name: name,
                calories: calories,
                protein: protein,
                carbs: carbs,
                fat: fat,
                sugar: sugar,
                time: new Date().toISOString(),
                fromMealPlan: false
            };
            
            // Save to today's log
            const today = getLocalDateString();
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }
            
            loggedMeals[today].meals.push(foodItem);
            loggedMeals[today].totalCalories += calories;
            
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            syncWithHomePage();
            
            // Save to saved meals if requested
            if (shouldSave) {
                let savedMeals = JSON.parse(localStorage.getItem('fuelfire_saved_meals') || '[]');
                const savedMeal = {
                    name: name,
                    calories: calories,
                    protein: protein,
                    carbs: carbs,
                    fat: fat,
                    sugar: sugar,
                    savedAt: new Date().toISOString()
                };
                savedMeals.push(savedMeal);
                localStorage.setItem('fuelfire_saved_meals', JSON.stringify(savedMeals));
                loadSavedMealsToSelect();
            }

            hideManualEntryModal();
            loadTodaysMeals();
        }
        
        // Meal Plan Selector Functions
        let selectedMealData = null;
        
        function showMealPlanSelector() {
            // Debug: Check all possible storage keys
            console.log('üîç DEBUG: Checking for meal plans...');
            const allKeys = Object.keys(localStorage);
            const mealKeys = allKeys.filter(key => key.toLowerCase().includes('meal') || key.toLowerCase().includes('plan'));
            console.log('üì¶ Found storage keys:', mealKeys);
            mealKeys.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    console.log(`   ${key}:`, value ? value.substring(0, 100) + '...' : 'empty');
                } catch (e) {
                    console.log(`   ${key}: error reading`);
                }
            });
            
            // Load saved meal plans from the correct storage key
            const savedPlans = JSON.parse(localStorage.getItem('fuelfire_meal_plans') || '[]');
            console.log('üìã Loaded', savedPlans.length, 'meal plans from fuelfire_meal_plans');
            
            const selectElement = document.getElementById('meal-plan-select');
            
            // Clear existing options
            selectElement.innerHTML = '<option value="">Choose a meal plan...</option>';
            
            if (savedPlans.length === 0) {
                console.log('‚ö†Ô∏è No plans found in fuelfire_meal_plans, checking other locations...');
                
                // Check for recent meal plan stored elsewhere
                const recentPlanText = localStorage.getItem('fuelfire_recent_meal_plan');
                const recentGoals = localStorage.getItem('fuelfire_recent_diet_goals');
                
                if (recentPlanText) {
                    console.log('‚úÖ Found recent meal plan text! Converting and saving...');
                    // Create a proper plan object from the recent data
                    const tempPlan = {
                        mealPlan: recentPlanText,
                        metadata: recentGoals ? JSON.parse(recentGoals) : { goal: 'recent' },
                        createdAt: new Date().toISOString(),
                        id: Date.now().toString()
                    };
                    
                    // Auto-save it to the proper storage location for future use
                    const newPlans = [tempPlan];
                    localStorage.setItem('fuelfire_meal_plans', JSON.stringify(newPlans));
                    console.log('üíæ Auto-saved recent plan to fuelfire_meal_plans for future use');
                    
                    // Store it temporarily for this session too
                    window.tempMealPlan = newPlans;
                    
                    const date = new Date().toLocaleDateString();
                    const goal = tempPlan.metadata?.goal || 'Recent';
                    selectElement.innerHTML += `<option value="0">${goal.charAt(0).toUpperCase() + goal.slice(1)} Plan - ${date}</option>`;
                    
                    document.getElementById('meal-plan-modal').style.display = 'block';
                    return;
                }
                
                selectElement.innerHTML += '<option value="">No saved meal plans found</option>';
                alert('No saved meal plans found!\n\nPlease create a meal plan first by:\n1. Going to Diet Creation\n2. Generating a meal plan\n\nThen return here to import meals!');
                return;
            }
            
            // Add meal plan options with better formatting
            savedPlans.forEach((plan, index) => {
                const date = new Date(plan.createdAt || plan.metadata?.createdAt).toLocaleDateString();
                const goal = plan.metadata?.goal || 'Unknown Goal';
                selectElement.innerHTML += `<option value="${index}">${goal.charAt(0).toUpperCase() + goal.slice(1)} Plan - ${date}</option>`;
            });
            
            document.getElementById('meal-plan-modal').style.display = 'block';
        }
        
        
        function hideMealPlanSelector() {
            document.getElementById('meal-plan-modal').style.display = 'none';
            document.getElementById('meal-plan-meals').style.display = 'none';
            document.getElementById('meal-type-selector').style.display = 'none';
            selectedMealData = null;
        }
        
        function loadMealPlanMeals() {
            const planIndex = document.getElementById('meal-plan-select').value;
            if (!planIndex) {
                document.getElementById('meal-plan-meals').style.display = 'none';
                return;
            }
            
            // Check if we're using the temporary plan
            let savedPlans = JSON.parse(localStorage.getItem('fuelfire_meal_plans') || '[]');
            if (savedPlans.length === 0 && window.tempMealPlan) {
                console.log('üìã Using temporary meal plan');
                savedPlans = window.tempMealPlan;
            }
            
            const selectedPlan = savedPlans[parseInt(planIndex)];
            
            if (!selectedPlan || !selectedPlan.mealPlan) {
                alert('No meal plan content found');
                return;
            }
            
            // Parse the meal plan content to extract individual meals
            const parsedMeals = parseMealPlanForImport(selectedPlan.mealPlan);
            
            if (parsedMeals.length === 0) {
                alert('No meals could be extracted from this meal plan');
                return;
            }
            
            const mealSelect = document.getElementById('meal-select');
            mealSelect.innerHTML = '<option value="">Choose a meal...</option>';
            
            // Add parsed meals to the select
            parsedMeals.forEach((meal, index) => {
                mealSelect.innerHTML += `<option value="${index}">${meal.day} - ${meal.type}: ${meal.name} (${meal.calories} cal)</option>`;
            });
            
            // Store parsed meals globally for later use
            window.currentParsedMeals = parsedMeals;
            
            document.getElementById('meal-plan-meals').style.display = 'block';
        }
        
        function parseMealPlanForImport(mealPlanText) {
            console.log('üî• SIMPLE & CLEAN parsing approach!');
            
            const meals = [];
            const lines = mealPlanText.split('\n');
            let currentDay = 'Day 1-5 (Weekdays)';
            
            for (let line of lines) {
                const trimmed = line.trim();
                
                // Update current day when we see day headers
                if (trimmed.includes('Day') && (trimmed.includes(':') || trimmed.includes('Saturday') || trimmed.includes('Sunday'))) {
                    currentDay = trimmed.replace(/^#+\s*/, '').replace(':', '').trim();
                    console.log('üìÖ Day section:', currentDay);
                    continue;
                }
                
                // Look for meal lines - they start with ** and have emojis
                if (trimmed.startsWith('**üç≥') || trimmed.startsWith('**ü•ó') || 
                    trimmed.startsWith('**üçΩÔ∏è') || trimmed.startsWith('**üçé')) {
                    
                    // Extract meal type
                    let mealType = 'breakfast';
                    if (trimmed.includes('Lunch')) mealType = 'lunch';
                    else if (trimmed.includes('Dinner')) mealType = 'dinner';
                    else if (trimmed.includes('Snacks')) mealType = 'snacks';
                    
                    // Extract everything after the colon and **
                    const description = trimmed.replace(/^\*\*[üç≥ü•óüçΩÔ∏èüçé]\s*(Breakfast|Lunch|Dinner|Snacks?):\*\*\s*/, '');
                    
                    // Get calories
                    const calMatch = description.match(/Cal:\s*(\d+)/);
                    const calories = calMatch ? parseInt(calMatch[1]) : 400;
                    
                    // Get meal name and ingredients (keep more detail now)
                    let name = description.split(' - ')[0].split('Cal:')[0].trim();
                    if (name.length > 80) name = name.substring(0, 77) + '...';
                    
                    // Extract macros if available
                    let protein = 25, carbs = 35, fat = 15;
                    const proteinMatch = description.match(/P:\s*(\d+)g?/i);
                    const carbsMatch = description.match(/C:\s*(\d+)g?/i);
                    const fatMatch = description.match(/F:\s*(\d+)g?/i);
                    
                    if (proteinMatch) protein = parseInt(proteinMatch[1]);
                    if (carbsMatch) carbs = parseInt(carbsMatch[1]);
                    if (fatMatch) fat = parseInt(fatMatch[1]);
                    
                    const meal = {
                        day: currentDay,
                        type: mealType,
                        name: name,
                        calories: calories,
                        protein: protein,
                        carbs: carbs,
                        fat: fat,
                        content: description
                    };
                    
                    meals.push(meal);
                    console.log(`‚úÖ ${mealType}: ${name} (${calories} cal)`);
                }
            }
            
            console.log(`üéØ Found ${meals.length} meals total!`);
            return meals;
        }
        
        function showMealTypeSelector() {
            const mealIndex = document.getElementById('meal-select').value;
            if (!mealIndex || !window.currentParsedMeals) {
                document.getElementById('meal-type-selector').style.display = 'none';
                return;
            }
            
            selectedMealData = window.currentParsedMeals[parseInt(mealIndex)];
            document.getElementById('meal-type-selector').style.display = 'block';
        }
        
        function logMealFromPlan(logAsType) {
            if (!selectedMealData) {
                alert('Please select a meal first');
                return;
            }
            
            const today = getLocalDateString();
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }
            
            const logEntry = {
                name: selectedMealData.name,
                type: logAsType,
                calories: selectedMealData.calories,
                protein: selectedMealData.protein,
                carbs: selectedMealData.carbs,
                fat: selectedMealData.fat,
                sugar: selectedMealData.sugar || 0,
                time: new Date().toISOString(),
                fromMealPlan: true,
                originalDay: selectedMealData.day,
                originalType: selectedMealData.type
            };
            
            loggedMeals[today].meals.push(logEntry);
            loggedMeals[today].totalCalories += selectedMealData.calories;
            
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            syncWithHomePage();
            
            alert(`‚úÖ ${selectedMealData.name} logged as ${logAsType}!\n\nüìä ${selectedMealData.calories} calories\nü•© ${selectedMealData.protein}g protein\nüçû ${selectedMealData.carbs}g carbs\nü•ë ${selectedMealData.fat}g fat\nüç≠ ${selectedMealData.sugar || 0}g sugar`);
            
            hideMealPlanSelector();
            loadTodaysMeals();
            loadQuickAdds();
        }
        
        // Meal Ideas Functions
        let selectedMealIdeaData = null;
        
        function showMealIdeasSelector() {
            document.getElementById('meal-ideas-modal').style.display = 'block';
        }
        
        function hideMealIdeasSelector() {
            document.getElementById('meal-ideas-modal').style.display = 'none';
            document.getElementById('meal-ideas-list').style.display = 'none';
            document.getElementById('meal-idea-type-selector').style.display = 'none';
            selectedMealIdeaData = null;
        }
        
        function loadMealIdeasByCategory() {
            const category = document.getElementById('meal-category-select').value;
            if (!category) {
                document.getElementById('meal-ideas-list').style.display = 'none';
                return;
            }
            
            // Define meal ideas for each category with calories and macros
            const mealIdeas = {
                beef: [
                    { name: "Classic Beef Burger", calories: 650, protein: 35, carbs: 45, fat: 35 },
                    { name: "Beef Stir Fry", calories: 520, protein: 40, carbs: 25, fat: 28 },
                    { name: "Steak with Sweet Potato", calories: 580, protein: 42, carbs: 35, fat: 25 },
                    { name: "Beef Tacos (3)", calories: 480, protein: 32, carbs: 38, fat: 22 },
                    { name: "Beef and Broccoli", calories: 420, protein: 38, carbs: 18, fat: 20 }
                ],
                chicken: [
                    { name: "Grilled Chicken Caesar Salad", calories: 450, protein: 40, carbs: 12, fat: 28 },
                    { name: "Chicken Breast with Rice", calories: 520, protein: 45, carbs: 55, fat: 8 },
                    { name: "Buffalo Chicken Wrap", calories: 480, protein: 35, carbs: 42, fat: 20 },
                    { name: "Chicken Stir Fry", calories: 390, protein: 38, carbs: 22, fat: 15 },
                    { name: "BBQ Chicken Pizza Slice", calories: 320, protein: 18, carbs: 35, fat: 12 }
                ],
                pork: [
                    { name: "Pulled Pork Sandwich", calories: 580, protein: 32, carbs: 48, fat: 28 },
                    { name: "Pork Chop with Applesauce", calories: 420, protein: 35, carbs: 25, fat: 20 },
                    { name: "Bacon and Eggs", calories: 350, protein: 25, carbs: 2, fat: 28 },
                    { name: "Pork Tenderloin", calories: 380, protein: 40, carbs: 8, fat: 18 },
                    { name: "BBQ Ribs (4 ribs)", calories: 680, protein: 45, carbs: 15, fat: 48 }
                ],
                shrimp: [
                    { name: "Shrimp Scampi with Pasta", calories: 520, protein: 32, carbs: 45, fat: 22 },
                    { name: "Shrimp Salad", calories: 280, protein: 25, carbs: 8, fat: 16 },
                    { name: "Coconut Shrimp (6 pieces)", calories: 420, protein: 20, carbs: 35, fat: 22 },
                    { name: "Shrimp Tacos (3)", calories: 380, protein: 28, carbs: 35, fat: 15 },
                    { name: "Garlic Butter Shrimp", calories: 320, protein: 30, carbs: 5, fat: 20 }
                ],
                turkey: [
                    { name: "Turkey Club Sandwich", calories: 480, protein: 32, carbs: 42, fat: 20 },
                    { name: "Turkey Meatballs with Marinara", calories: 350, protein: 28, carbs: 18, fat: 18 },
                    { name: "Roasted Turkey Breast", calories: 320, protein: 38, carbs: 0, fat: 15 },
                    { name: "Turkey Chili Bowl", calories: 280, protein: 25, carbs: 22, fat: 12 },
                    { name: "Turkey Burger", calories: 420, protein: 30, carbs: 35, fat: 18 }
                ],
                sandwiches: [
                    { name: "Classic BLT", calories: 480, protein: 18, carbs: 35, fat: 32 },
                    { name: "Grilled Cheese & Tomato Soup", calories: 620, protein: 22, carbs: 65, fat: 28 },
                    { name: "Philly Cheesesteak", calories: 720, protein: 38, carbs: 48, fat: 42 },
                    { name: "Italian Sub", calories: 680, protein: 32, carbs: 55, fat: 38 },
                    { name: "Tuna Melt", calories: 520, protein: 28, carbs: 38, fat: 28 }
                ],
                keto: [
                    { name: "Keto Cauliflower Mac & Cheese", calories: 380, protein: 18, carbs: 8, fat: 32 },
                    { name: "Avocado Bacon Salad", calories: 420, protein: 15, carbs: 12, fat: 38 },
                    { name: "Keto Chicken Thighs", calories: 480, protein: 35, carbs: 3, fat: 36 },
                    { name: "Zucchini Noodles with Pesto", calories: 320, protein: 12, carbs: 10, fat: 28 },
                    { name: "Keto Beef Bowl", calories: 520, protein: 40, carbs: 8, fat: 38 }
                ],
                fusion: [
                    { name: "Korean BBQ Bowl", calories: 580, protein: 35, carbs: 55, fat: 22 },
                    { name: "Sushi Bowl", calories: 450, protein: 28, carbs: 48, fat: 18 },
                    { name: "Thai Curry Chicken", calories: 520, protein: 32, carbs: 35, fat: 28 },
                    { name: "Mexican Street Corn Salad", calories: 320, protein: 8, carbs: 35, fat: 18 },
                    { name: "Mediterranean Quinoa Bowl", calories: 480, protein: 18, carbs: 55, fat: 20 }
                ]
            };
            
            const mealSelect = document.getElementById('meal-idea-select');
            mealSelect.innerHTML = '<option value="">Choose a meal...</option>';
            
            const categoryMeals = mealIdeas[category] || [];
            categoryMeals.forEach((meal, index) => {
                mealSelect.innerHTML += `<option value="${index}">${meal.name} (${meal.calories} cal)</option>`;
            });
            
            document.getElementById('meal-ideas-list').style.display = 'block';
            window.currentCategoryMeals = categoryMeals;
        }
        
        function showMealIdeaTypeSelector() {
            const mealIndex = document.getElementById('meal-idea-select').value;
            if (!mealIndex || !window.currentCategoryMeals) {
                document.getElementById('meal-idea-type-selector').style.display = 'none';
                return;
            }
            
            selectedMealIdeaData = window.currentCategoryMeals[parseInt(mealIndex)];
            document.getElementById('meal-idea-type-selector').style.display = 'block';
        }
        
        function logMealFromIdea(logAsType) {
            if (!selectedMealIdeaData) {
                alert('Please select a meal first');
                return;
            }
            
            const today = getLocalDateString();
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }
            
            const logEntry = {
                name: selectedMealIdeaData.name,
                type: logAsType,
                calories: selectedMealIdeaData.calories,
                protein: selectedMealIdeaData.protein,
                carbs: selectedMealIdeaData.carbs,
                fat: selectedMealIdeaData.fat,
                sugar: selectedMealIdeaData.sugar || 0,
                time: new Date().toISOString(),
                fromMealIdeas: true
            };
            
            loggedMeals[today].meals.push(logEntry);
            loggedMeals[today].totalCalories += selectedMealIdeaData.calories;
            
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            syncWithHomePage();
            
            alert(`‚úÖ ${selectedMealIdeaData.name} logged as ${logAsType}!\n\nüìä ${selectedMealIdeaData.calories} calories\nü•© ${selectedMealIdeaData.protein}g protein\nüçû ${selectedMealIdeaData.carbs}g carbs\nü•ë ${selectedMealIdeaData.fat}g fat\nüç≠ ${selectedMealIdeaData.sugar || 0}g sugar`);
            
            hideMealIdeasSelector();
            loadTodaysMeals();
        }
        
        // Voice logging function is defined earlier in the file

        // Smart Entry Function
        function showSmartEntryDuplicate_REMOVED() {
            // REMOVED - This was a duplicate function causing conflicts
            const smartSuggestions = [
                'ü•ó Grilled Chicken Salad - 320 cal',
                'üçï 2 Slices Pizza - 540 cal',
                'üçî Cheeseburger with Fries - 750 cal',
                'ü•§ Protein Shake - 250 cal',
                'üçé Apple with Peanut Butter - 195 cal',
                'üç≥ 3 Eggs with Toast - 420 cal'
            ];
            
            const suggestion = smartSuggestions[Math.floor(Math.random() * smartSuggestions.length)];
            
            if (confirm(`üí° Smart Suggestion:\n\n${suggestion}\n\nWould you like to add this to your log?`)) {
                const parts = suggestion.split(' - ');
                const foodName = parts[0].replace(/[ü•óüçïüçîü•§üçéüç≥] /, '');
                const calories = parseInt(parts[1]);
                
                // This function is deprecated - use the smart entry modal instead
                alert('Please use the Type or Voice button to add foods.');
            }
        }
        
        
        // Show Meal Ideas Selector
        function showMealIdeasSelector() {
            window.location.href = 'meal-ideas.html';
        }
        
        // Manual Food Entry - New version for the modal
        function addManualFood() {
            const name = document.getElementById('manual-food-name').value;
            const calories = parseInt(document.getElementById('manual-calories').value) || 0;
            const protein = parseInt(document.getElementById('manual-protein').value) || 0;
            const carbs = parseInt(document.getElementById('manual-carbs').value) || 0;
            const fat = parseInt(document.getElementById('manual-fat').value) || 0;
            const sugar = parseInt(document.getElementById('manual-sugar').value) || 0;

            if (!name) {
                alert('Please enter a food name');
                return;
            }

            if (!calories) {
                alert('Please enter calories');
                return;
            }

            // Ask for meal type
            const mealType = prompt('Log as:\n1. Breakfast\n2. Lunch\n3. Dinner\n4. Snack\n\nEnter number (1-4):');
            if (!mealType) return;

            const types = ['', 'breakfast', 'lunch', 'dinner', 'snack'];
            const type = types[parseInt(mealType)] || 'snack';

            // Log the food
            const today = getLocalDateString();
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');

            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }

            loggedMeals[today].meals.push({
                name: name,
                type: type,
                calories: calories,
                protein: protein,
                carbs: carbs,
                fat: fat,
                sugar: sugar,
                time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                source: 'manual'
            });
            
            loggedMeals[today].totalCalories += calories;
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            
            // Update UI
            syncWithHomePage();
            updateTodayProgress();
            loadTodaysMeals();
            loadQuickAdds();
            
            // Clear form
            document.getElementById('manual-food-name').value = '';
            document.getElementById('manual-calories').value = '';
            document.getElementById('manual-protein').value = '';
            document.getElementById('manual-carbs').value = '';
            document.getElementById('manual-fat').value = '';
            document.getElementById('manual-sugar').value = '';
            
            // Close modal
            closeSmartEntry();
            
            alert(`‚úÖ Added ${name} (${calories} cal) to ${type}!`);
        }
        
        // Sync with home page overview
        function syncWithHomePage() {
            // This ensures the home page always shows current data when navigating back
            const today = getLocalDateString();
            const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            const todayData = loggedMeals[today] || { meals: [], totalCalories: 0 };

            console.log('üîÑ Syncing with home page:', todayData);

            // Trigger storage event to update other tabs/pages
            window.localStorage.setItem('fuelfire_nutrition_updated', Date.now().toString());
            console.log('‚úÖ Set fuelfire_nutrition_updated to', Date.now());
        }

        // Check if we need to reset for a new day
        function checkAndResetForNewDay() {
            const lastDate = localStorage.getItem('fuelfire_last_active_date');
            const today = getLocalDateString();

            if (lastDate && lastDate !== today) {
                // It's a new day - data persists but we just update the date
                console.log('New day detected - meals from previous days remain in storage');
            }

            localStorage.setItem('fuelfire_last_active_date', today);
        }

        // Initialize
        window.addEventListener('load', function() {
            checkAndResetForNewDay();
            updateTodayProgress();
            loadTodaysMeals();
            loadQuickAddGrid(); // Load Quick Add emoji buttons
            loadQuickAdds(); // Load Quick Add from history

            // Set up interval to check for day change (every minute)
            setInterval(() => {
                const lastDate = localStorage.getItem('fuelfire_last_active_date');
                const today = getLocalDateString();

                if (lastDate !== today) {
                    checkAndResetForNewDay();
                    updateTodayProgress();
                    loadTodaysMeals();
                }
            }, 60000); // Check every minute

            // Set up interval to refresh active calories balance (every 10 seconds)
            setInterval(() => {
                loadTodaysMeals();
            }, 10000); // Refresh every 10 seconds to show updated active calories

            // Check for mode parameter in URL (from Log Food modal menu)
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const showEntry = urlParams.get('showEntry');

            if (mode) {
                // Auto-open the selected input method
                setTimeout(() => {
                    switch(mode) {
                        case 'scan':
                            startBarcodeScanning();
                            break;
                        case 'voice':
                            startVoiceLogging();
                            break;
                        case 'manual':
                            showSmartEntry();
                            showManualEntry();
                            break;
                    }
                }, 500); // Small delay to ensure page is fully loaded
            } else if (showEntry === 'true') {
                // Auto-open smart entry modal when coming from food tracker button
                setTimeout(() => {
                    showSmartEntry();
                }, 500);
            }
        });
    </script>

</body>
</html>