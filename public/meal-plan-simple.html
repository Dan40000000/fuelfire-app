<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Your AI Meal Plan - Well Fit</title>
    <link rel="stylesheet" href="styles.css">
    <script src="global-nav.js"></script>
    <script src="quick-food-entry.js"></script>
    <style>
        .meal-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .meal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }
        
        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .meal-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        
        .meal-calories {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .meal-description {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .log-meal-btn {
            background: rgba(40, 167, 69, 0.9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            float: right;
        }
        
        .log-meal-btn:hover {
            background: rgba(40, 167, 69, 1);
            transform: scale(1.05);
        }
        
        .log-meal-btn:disabled {
            background: rgba(108, 117, 125, 0.8);
            cursor: not-allowed;
            transform: none;
        }
        
        .day-section {
            margin-bottom: 30px;
        }
        
        .day-header {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .day-title {
            color: #667eea;
            font-size: 20px;
            font-weight: bold;
            margin: 0 0 5px 0;
        }
        
        .day-summary {
            color: #666;
            font-size: 14px;
            margin: 0;
        }
        
        .shopping-section {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.1);
        }
        
        .shopping-title {
            color: #4CAF50;
            font-size: 22px;
            font-weight: bold;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .shopping-list {
            line-height: 1.8;
            color: #333;
        }
        
        .shopping-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(76, 175, 80, 0.1);
            transition: all 0.3s ease;
        }
        
        .shopping-item:last-child {
            border-bottom: none;
        }
        
        .shopping-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #4CAF50;
            border-radius: 50%;
            margin-right: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .shopping-checkbox:hover {
            background: rgba(76, 175, 80, 0.1);
            transform: scale(1.1);
        }
        
        .shopping-checkbox.checked {
            background: #4CAF50;
            color: white;
            font-size: 12px;
        }
        
        .shopping-text {
            flex: 1;
            transition: all 0.3s ease;
        }
        
        .shopping-text.checked {
            text-decoration: line-through;
            color: #888;
            opacity: 0.7;
        }
        
        .shopping-progress {
            background: rgba(255,255,255,0.8);
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .summary-section {
            background: linear-gradient(135deg, #fff3e0 0%, #ffeaa7 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            border-left: 4px solid #FF9800;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.1);
        }
        
        .summary-title {
            color: #F57C00;
            font-size: 22px;
            font-weight: bold;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .macro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .macro-card {
            background: rgba(255,255,255,0.8);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .macro-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .macro-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .breakfast-card { background: linear-gradient(135deg, #FFD93D, #FF9800); }
        .lunch-card { background: linear-gradient(135deg, #4ECDC4, #44A08D); }
        .dinner-card { background: linear-gradient(135deg, #667eea, #764ba2); }
        .snack-card { background: linear-gradient(135deg, #FF6B6B, #FF5252); }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="screen">
            <!-- Status Bar -->
            <div class="status-bar">
                
                
            </div>


            <div class="header">
                <button onclick="window.location.href='meal-plans.html'" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 10px; cursor: pointer; font-size: 16px; margin-right: 10px;">
                    ‚Üê Back
                </button>
                <div class="header-title">Your Meal Plan</div>
            </div>

            <div class="content">
                <div style="padding: 20px;">
                    <!-- Saved Confirmation Banner -->
                    <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 15px 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);">
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">‚úÖ Meal Plan Saved!</div>
                        <div style="font-size: 13px; opacity: 0.95;">Access anytime from <a href="meal-plans.html" style="color: white; text-decoration: underline; font-weight: bold;">Meal Plans</a> page</div>
                    </div>

                    <div class="plan-header">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="color: var(--primary); margin: 0 0 10px 0; font-size: 24px;">üéØ AI Meal Plan</h2>
                            <div class="plan-metadata" id="plan-metadata" style="background: #f8f9ff; padding: 10px; border-radius: 10px; font-size: 14px; color: #666;">
                                <!-- Metadata will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <div id="meal-plan-content">
                        <!-- Meal plan content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay for sidebar -->
    <div class="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">üî• Well Fit</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item" onclick="window.location.href='index.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Home
            </div>
            <div class="menu-item" onclick="window.location.href='index.html#create-workout'" ontouchstart="" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <rect x="2" y="9" width="4" height="6" rx="1" fill="currentColor"/>
                    <rect x="18" y="9" width="4" height="6" rx="1" fill="currentColor"/>
                    <rect x="6" y="11" width="12" height="2" rx="1" fill="currentColor"/>
                    <circle cx="4" cy="12" r="1.5" fill="#fff"/>
                    <circle cx="20" cy="12" r="1.5" fill="#fff"/>
                </svg>
                Create Workout
            </div>
            <div class="menu-item" onclick="window.location.href='index.html#saved-workouts'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9L11 5H19C19.5304 5 20.0391 5.21071 20.4142 5.58579C20.7893 5.96086 21 6.46957 21 7V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Saved Workouts
            </div>
            <div class="menu-item" onclick="window.location.href='index.html#track-workouts'" ontouchstart="" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M3 3V18C3 18.5304 3.21071 19.0391 3.58579 19.4142C3.96086 19.7893 4.46957 20 5 20H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M7 14L12 9L16 13L21 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Track Workouts
            </div>
            <div class="menu-item" onclick="window.location.href='calorie-tracker.html'" ontouchstart="" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M13.5 0.67C13.5 0.67 14.24 3.32 14.24 5.47C14.24 7.53 12.89 9.2 10.83 9.2C8.76 9.2 7.2 7.53 7.2 5.47L7.23 5.1C5.21 7.5 4 10.61 4 14C4 19.5 8.5 24 14 24C19.5 24 24 19.5 24 14C24 8.36 18.37 3.29 13.5 0.67Z" fill="currentColor"/>
                </svg>
                Calorie Tracker
            </div>
            <div class="menu-item" onclick="window.location.href='health-dashboard.html'" ontouchstart="" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.27 2 8.5C2 5.41 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.08C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.41 22 8.5C22 12.27 18.6 15.36 13.45 20.03L12 21.35Z" fill="currentColor"/>
                </svg>
                Health Dashboard
            </div>
            <div class="menu-item" onclick="window.location.href='enhanced-diet-quiz.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                    <circle cx="12" cy="12" r="2" fill="currentColor"/>
                    <path d="M12 2V12L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Diet Creation
            </div>
            <div class="menu-item active" onclick="window.location.href='meal-plans.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M12 3C12 3 16 8 16 12C16 14.2 14.2 16 12 16C9.8 16 8 14.2 8 12C8 8 12 3 12 3Z" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
                Meal Plans
            </div>
            <div class="menu-item" onclick="window.location.href='meal-ideas.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M12 1V3M12 21V23M23 12H21M3 12H1M20.49 3.51L18.36 5.64M5.64 18.36L3.51 20.49M20.49 20.49L18.36 18.36M5.64 5.64L3.51 3.51" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Meal Ideas
            </div>
            <div class="menu-item" onclick="window.location.href='supplements.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <rect x="9" y="2" width="6" height="20" rx="3" stroke="currentColor" stroke-width="2" fill="none"/>
                    <path d="M9 8H15M9 12H15M9 16H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Supplements
            </div>
            <div class="menu-item" onclick="window.location.href='workout-techniques.html'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <circle cx="8" cy="8" r="2" fill="currentColor"/>
                    <path d="M8 10V14M8 14L6 20M8 14L10 20M8 14L12 12M12 12L10 6M12 12L14 6M12 12L16 14M16 14L14 20M16 14L18 20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Workout Techniques
            </div>
            <div class="menu-item" onclick="window.location.href='index.html#progress'" ontouchstart="" style="touch-action: manipulation; -webkit-tap-highlight-color: rgba(0,0,0,0.1);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M18 20V10M12 20V4M6 20V14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Goals & Progress
            </div>
        </div>
    </div>

    <script>
        function goBack() {
            window.location.href = 'meal-plans.html';
        }
        
        window.toggleSidebar = function() {
            var sidebar = document.getElementById('sidebar');
            var overlay = document.querySelector('.overlay');
            if (sidebar) sidebar.classList.toggle('open');
            if (overlay) overlay.classList.toggle('show');
        };
        
        window.goToPage = function(page) {
            window.location.href = page;
        };
        
        function updateTime() {
            const timeElement = document.getElementById('time');
            if (!timeElement) return; // Element doesn't exist on this page

            const now = new Date();
            const time = now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
            timeElement.textContent = time;
        }
        
        function enhanceMealPlanWithButtons(content) {
            // Extract meals and add log buttons
            let enhanced = content;
            
            // Pattern to find meals with calories
            const mealPattern = /(\*\*(?:üç≥ Breakfast|ü•ó Lunch|üçΩÔ∏è Dinner|üçé Snacks?):\*\*[\s\S]*?Calories:\s*(\d+))/g;
            
            enhanced = enhanced.replace(mealPattern, (match, mealContent, calories) => {
                // Extract meal type
                const mealTypeMatch = match.match(/\*\*(.*?):\*\*/);
                const mealType = mealTypeMatch ? mealTypeMatch[1] : 'Meal';
                
                // Extract day number
                const dayMatch = content.substring(0, content.indexOf(match)).match(/Day (\d+)/g);
                const day = dayMatch ? dayMatch[dayMatch.length - 1].match(/\d+/)[0] : '1';
                
                // Add log button
                const buttonId = `log-${day}-${mealType.replace(/[^a-zA-Z]/g, '')}`;
                const logButton = `<button onclick="logMeal('${day}', '${mealType}', ${calories})" id="${buttonId}" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 15px; font-size: 12px; margin-left: 10px; cursor: pointer;">‚úì Log This Meal</button>`;
                
                return match + ' ' + logButton;
            });
            
            return enhanced;
        }
        
        function logMeal(day, mealType, calories, mealId) {
            // Get today's date
            const today = new Date().toISOString().split('T')[0];
            
            // Get existing logged meals
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            // Initialize today's log if it doesn't exist
            if (!loggedMeals[today]) {
                loggedMeals[today] = {
                    meals: [],
                    totalCalories: 0
                };
            }
            
            // Add this meal
            loggedMeals[today].meals.push({
                day: day,
                type: mealType,
                calories: calories,
                time: new Date().toISOString(),
                fromMealPlan: true
            });
            
            // Update total
            loggedMeals[today].totalCalories += calories;
            
            // Save to localStorage
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            
            // Update button to show logged
            const button = event.target;
            button.style.background = 'rgba(108, 117, 125, 0.8)';
            button.innerHTML = '‚úÖ Logged!';
            button.disabled = true;
            
            // Show success message
            showToast(`‚úÖ ${mealType} logged! (+${calories} calories)`);
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 15px 25px;
                border-radius: 25px;
                font-size: 14px;
                z-index: 9999;
                animation: slideUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
        
        function displayMealPlan(mealPlan, metadata) {
            console.log('üìã Displaying meal plan:', {
                mealPlanLength: mealPlan ? mealPlan.length : 0,
                mealPlanType: typeof mealPlan,
                metadataKeys: metadata ? Object.keys(metadata) : []
            });
            
            // Set metadata
            document.getElementById('plan-metadata').innerHTML = `
                üéØ <strong>Generated:</strong> ${new Date(metadata.generatedAt || metadata.createdAt).toLocaleDateString()} | 
                <strong>Goal:</strong> ${metadata.goal} | 
                <strong>Duration:</strong> ${metadata.planDuration || '2-week'}
            `;
            
            if (!mealPlan || mealPlan.length === 0) {
                document.getElementById('meal-plan-content').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>‚ö†Ô∏è Empty Meal Plan</h3>
                        <p>The meal plan appears to be empty. Please try generating a new one.</p>
                        <button onclick="window.location.href='enhanced-diet-quiz.html'" style="background: var(--gradient-1); color: white; border: none; padding: 10px 20px; border-radius: 15px;">üéØ Start New Quiz</button>
                    </div>
                `;
                return;
            }
            
            // Parse the meal plan content into structured data
            const structuredContent = parseMealPlanContent(mealPlan);
            
            // Generate beautiful HTML using the structured data
            const content = generateBeautifulMealPlanHTML(structuredContent);
            
            document.getElementById('meal-plan-content').innerHTML = content;
        }
        
        function parseMealPlanContent(content) {
            const lines = content.split('\n');
            const structured = {
                shopping: '',
                shoppingWeek1: '',
                shoppingWeek2: '',
                days: [],
                summaries: []
            };
            
            let currentDay = null;
            let currentSection = '';
            let inShopping = false;
            let currentShoppingWeek = '';
            
            for (let line of lines) {
                const trimmed = line.trim();

                // Week-specific shopping lists (check BEFORE general shopping list)
                if (trimmed.match(/Week\s*1.*Shopping/i) || (trimmed.includes('Week 1') && inShopping)) {
                    inShopping = true;
                    currentShoppingWeek = 'week1';
                    currentSection = 'shopping';
                    console.log('üìã Found Week 1 shopping list');
                    continue;
                }
                if (trimmed.match(/Week\s*2.*Shopping/i) || (trimmed.includes('Week 2') && inShopping)) {
                    inShopping = true;
                    currentShoppingWeek = 'week2';
                    currentSection = 'shopping';
                    console.log('üìã Found Week 2 shopping list');
                    continue;
                }

                // Shopping list section (general)
                if (trimmed.includes('Shopping List') || trimmed.includes('SHOPPING LIST')) {
                    inShopping = true;
                    currentSection = 'shopping';
                    // If we haven't set a week yet, this is general shopping
                    if (!currentShoppingWeek) {
                        console.log('üìã Found general shopping list');
                    }
                    continue;
                }
                
                // Day headers
                const dayMatch = trimmed.match(/^###?\s*(Day \d+)/i);
                if (dayMatch) {
                    if (currentDay) structured.days.push(currentDay);
                    currentDay = {
                        title: dayMatch[1],
                        meals: [],
                        total: ''
                    };
                    inShopping = false;
                    currentSection = 'day';
                    continue;
                }
                
                // Week summaries
                const weekMatch = trimmed.match(/\*\*(Week \d+ Summary:)\*\*/);
                if (weekMatch) {
                    inShopping = false;
                    currentSection = 'summary';
                    continue;
                }
                
                // Meal headers - expanded pattern matching
                const mealMatch = trimmed.match(/\*\*.*?(Breakfast|Lunch|Dinner|Snacks?).*?\*\*/i);
                if (mealMatch && currentDay) {
                    const meal = {
                        type: trimmed.replace(/\*\*/g, ''), // Keep full text including emojis
                        content: '',
                        calories: 0
                    };
                    currentDay.meals.push(meal);
                    continue;
                }
                
                // Day totals
                const totalMatch = trimmed.match(/\*\*(Day Total:)\*\* (.*)/);
                if (totalMatch && currentDay) {
                    currentDay.total = totalMatch[2];
                    continue;
                }
                
                // Add content to appropriate section
                if (inShopping && trimmed) {
                    if (currentShoppingWeek === 'week1') {
                        structured.shoppingWeek1 += line + '\n';
                    } else if (currentShoppingWeek === 'week2') {
                        structured.shoppingWeek2 += line + '\n';
                    } else {
                        // If no specific week, try to auto-detect or add to general
                        structured.shopping += line + '\n';
                    }
                } else if (currentDay && currentDay.meals.length > 0 && trimmed) {
                    const currentMeal = currentDay.meals[currentDay.meals.length - 1];
                    
                    // Skip if this is another meal header
                    if (!trimmed.match(/\*\*.*?(Breakfast|Lunch|Dinner|Snacks?).*?\*\*/i)) {
                        currentMeal.content += line + '\n';
                        
                        // Extract calories
                        const calMatch = line.match(/Calories:\s*(\d+)/);
                        if (calMatch) {
                            currentMeal.calories = parseInt(calMatch[1]);
                        }
                    }
                }
            }
            
            if (currentDay) structured.days.push(currentDay);
            
            // If no week-specific shopping lists were found, split the general list
            if (!structured.shoppingWeek1 && !structured.shoppingWeek2 && structured.shopping) {
                const splitShopping = smartSplitShoppingList(structured.shopping, structured.days);
                structured.shoppingWeek1 = splitShopping.week1;
                structured.shoppingWeek2 = splitShopping.week2;
            }
            
            return structured;
        }
        
        function generateBeautifulMealPlanHTML(structured) {
            let html = '';

            console.log('üõí Shopping list data:', {
                hasWeek1: !!structured.shoppingWeek1,
                hasWeek2: !!structured.shoppingWeek2,
                hasGeneral: !!structured.shopping,
                week1Length: structured.shoppingWeek1 ? structured.shoppingWeek1.length : 0,
                week2Length: structured.shoppingWeek2 ? structured.shoppingWeek2.length : 0
            });

            // Shopping list sections
            if (structured.shoppingWeek1 || structured.shoppingWeek2 || structured.shopping) {
                if (structured.shoppingWeek1) {
                    const week1Items = parseShoppingList(structured.shoppingWeek1);
                    const week1HTML = generateInteractiveShoppingList(week1Items, 'week1');
                    const checkableCount1 = week1Items.filter(item => !item.isHeader).length;

                    html += `
                        <div class="shopping-section">
                            <h2 class="shopping-title" onclick="toggleShoppingSection('week1')" style="cursor: pointer; user-select: none;">
                                <span id="shopping-arrow-week1">‚ñº</span> üõí Week 1 Shopping List
                            </h2>
                            <div id="shopping-content-week1">
                                <div class="shopping-progress" id="shopping-progress-week1">0 of ${checkableCount1} items checked</div>
                                <div class="shopping-list" id="shopping-list-week1">${week1HTML}</div>
                            </div>
                        </div>
                    `;
                }

                if (structured.shoppingWeek2) {
                    const week2Items = parseShoppingList(structured.shoppingWeek2);
                    const week2HTML = generateInteractiveShoppingList(week2Items, 'week2');
                    const checkableCount2 = week2Items.filter(item => !item.isHeader).length;

                    html += `
                        <div class="shopping-section" style="margin-top: 30px;">
                            <h2 class="shopping-title" onclick="toggleShoppingSection('week2')" style="cursor: pointer; user-select: none;">
                                <span id="shopping-arrow-week2">‚ñº</span> üõí Week 2 Shopping List
                            </h2>
                            <div id="shopping-content-week2">
                                <div class="shopping-progress" id="shopping-progress-week2">0 of ${checkableCount2} items checked</div>
                                <div class="shopping-list" id="shopping-list-week2">${week2HTML}</div>
                            </div>
                        </div>
                    `;
                }

                // Fallback for single shopping list
                if (!structured.shoppingWeek1 && !structured.shoppingWeek2 && structured.shopping) {
                    const shoppingItems = parseShoppingList(structured.shopping);
                    const shoppingHTML = generateInteractiveShoppingList(shoppingItems, 'general');
                    const checkableCount = shoppingItems.filter(item => !item.isHeader).length;

                    html += `
                        <div class="shopping-section">
                            <h2 class="shopping-title" onclick="toggleShoppingSection('general')" style="cursor: pointer; user-select: none;">
                                <span id="shopping-arrow-general">‚ñº</span> üõí Shopping List
                            </h2>
                            <div id="shopping-content-general">
                                <div class="shopping-progress" id="shopping-progress-general">0 of ${checkableCount} items checked</div>
                                <div class="shopping-list" id="shopping-list-general">${shoppingHTML}</div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Days sections
            structured.days.forEach(day => {
                html += `<div class="day-section">`;
                html += `
                    <div class="day-header">
                        <h3 class="day-title">üìÖ ${day.title}</h3>
                        <p class="day-summary">Complete daily meal plan with balanced nutrition</p>
                    </div>
                `;
                
                // Meals
                day.meals.forEach((meal, mealIndex) => {
                    const mealClass = getMealCardClass(meal.type);
                    const mealId = `${day.title.replace(' ', '')}-${meal.type.replace(/[^\w]/g, '')}-${mealIndex}`;
                    
                    html += `
                        <div class="meal-card ${mealClass}">
                            <div class="meal-header">
                                <h4 class="meal-title">${meal.type}</h4>
                                ${meal.calories > 0 ? `<div class="meal-calories">${meal.calories} cal</div>` : ''}
                            </div>
                            <div class="meal-description">${meal.content.replace(/\n/g, '<br>')}</div>
                            ${meal.calories > 0 ? `<button class="log-meal-btn" onclick="logMeal('${day.title}', '${meal.type}', ${meal.calories}, '${mealId}')">‚úì Log Meal</button>` : ''}
                            <div style="clear: both;"></div>
                        </div>
                    `;
                });
                
                // Day total
                if (day.total) {
                    html += `
                        <div class="summary-section">
                            <h3 class="summary-title">üìä Day Total</h3>
                            <div>${day.total}</div>
                            ${generateMacroCards(day.total)}
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            return html;
        }
        
        function getMealCardClass(mealType) {
            if (mealType.includes('Breakfast')) return 'breakfast-card';
            if (mealType.includes('Lunch')) return 'lunch-card';
            if (mealType.includes('Dinner')) return 'dinner-card';
            if (mealType.includes('Snack')) return 'snack-card';
            return '';
        }
        
        function generateMacroCards(totalText) {
            const calorieMatch = totalText.match(/(\d+)\s*calories/i);
            const proteinMatch = totalText.match(/P:\s*(\d+)g/i);
            const carbMatch = totalText.match(/C:\s*(\d+)g/i);
            const fatMatch = totalText.match(/F:\s*(\d+)g/i);
            
            if (calorieMatch || proteinMatch || carbMatch || fatMatch) {
                return `
                    <div class="macro-grid">
                        ${calorieMatch ? `<div class="macro-card"><div class="macro-value">${calorieMatch[1]}</div><div class="macro-label">Calories</div></div>` : ''}
                        ${proteinMatch ? `<div class="macro-card"><div class="macro-value">${proteinMatch[1]}g</div><div class="macro-label">Protein</div></div>` : ''}
                        ${carbMatch ? `<div class="macro-card"><div class="macro-value">${carbMatch[1]}g</div><div class="macro-label">Carbs</div></div>` : ''}
                        ${fatMatch ? `<div class="macro-card"><div class="macro-value">${fatMatch[1]}g</div><div class="macro-label">Fat</div></div>` : ''}
                    </div>
                `;
            }
            return '';
        }
        
        function parseShoppingList(shoppingText) {
            const lines = shoppingText.split('\n').filter(line => line.trim());
            const items = [];
            
            for (let line of lines) {
                const trimmed = line.trim();
                if (trimmed && !trimmed.startsWith('#') && !trimmed.toLowerCase().includes('shopping list')) {
                    // Check if this is a section header (like "Fruits:", "Vegetables:", etc.)
                    const isHeader = trimmed.endsWith(':') || trimmed.match(/^\*\*.*\*\*$/);
                    
                    if (isHeader) {
                        // This is a section header - add as title, not checkable item
                        items.push({
                            text: trimmed.replace(/[\*:]/g, '').trim(),
                            isHeader: true
                        });
                    } else {
                        // Remove any existing bullet points or dashes
                        let cleanItem = trimmed.replace(/^[-‚Ä¢*]\s*/, '');
                        if (cleanItem) {
                            items.push({
                                text: cleanItem,
                                isHeader: false
                            });
                        }
                    }
                }
            }
            
            return items;
        }
        
        function generateInteractiveShoppingList(items, weekId) {
            return items.map((item, index) => {
                if (item.isHeader) {
                    // Generate section header without checkbox
                    return `
                        <div class="shopping-header" style="margin-top: 20px; margin-bottom: 10px;">
                            <h4 style="color: #4CAF50; font-weight: bold; font-size: 16px; margin: 0;">${item.text}</h4>
                        </div>
                    `;
                } else {
                    // Generate regular item with checkbox
                    return `
                        <div class="shopping-item" id="shopping-item-${weekId}-${index}">
                            <div class="shopping-checkbox" onclick="toggleShoppingItem('${weekId}', ${index})" id="checkbox-${weekId}-${index}">
                            </div>
                            <div class="shopping-text" id="text-${weekId}-${index}">${item.text}</div>
                        </div>
                    `;
                }
            }).join('');
        }
        
        function toggleShoppingSection(sectionId) {
            const content = document.getElementById(`shopping-content-${sectionId}`);
            const arrow = document.getElementById(`shopping-arrow-${sectionId}`);

            if (content && arrow) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    arrow.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    arrow.textContent = '‚ñ∂';
                }
            }
        }

        function toggleShoppingItem(weekId, index) {
            const checkbox = document.getElementById(`checkbox-${weekId}-${index}`);
            const text = document.getElementById(`text-${weekId}-${index}`);
            const isChecked = checkbox.classList.contains('checked');
            
            if (isChecked) {
                // Uncheck
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
                text.classList.remove('checked');
            } else {
                // Check
                checkbox.classList.add('checked');
                checkbox.innerHTML = '‚úì';
                text.classList.add('checked');
            }
            
            // Update progress for this specific week
            updateShoppingProgress(weekId);
        }
        
        function updateShoppingProgress(weekId) {
            const checkboxes = document.querySelectorAll(`#shopping-list-${weekId} .shopping-checkbox`);
            const checkedBoxes = document.querySelectorAll(`#shopping-list-${weekId} .shopping-checkbox.checked`);
            const progress = document.getElementById(`shopping-progress-${weekId}`);
            
            if (progress && checkboxes.length > 0) {
                const checkedCount = checkedBoxes.length;
                const totalCount = checkboxes.length;
                const percentage = Math.round((checkedCount / totalCount) * 100);
                
                progress.innerHTML = `${checkedCount} of ${totalCount} items checked (${percentage}%)`;
                
                if (checkedCount === totalCount) {
                    const weekName = weekId === 'week1' ? 'Week 1' : weekId === 'week2' ? 'Week 2' : 'All';
                    progress.innerHTML = `üéâ ${weekName} shopping complete! All ${totalCount} items checked`;
                    progress.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                    progress.style.color = 'white';
                } else {
                    progress.style.background = 'rgba(255,255,255,0.8)';
                    progress.style.color = '#4CAF50';
                }
            }
        }
        
        function smartSplitShoppingList(shoppingText, days) {
            const items = parseShoppingList(shoppingText);
            const midPoint = Math.ceil(items.length / 2);

            const week1Items = items.slice(0, midPoint);
            const week2Items = items.slice(midPoint);

            // Convert objects back to text strings
            const week1Text = week1Items.map(item => {
                if (item.isHeader) {
                    return `**${item.text}**`;
                } else {
                    return item.text;
                }
            }).join('\n');

            const week2Text = week2Items.map(item => {
                if (item.isHeader) {
                    return `**${item.text}**`;
                } else {
                    return item.text;
                }
            }).join('\n');

            return {
                week1: week1Text,
                week2: week2Text
            };
        }
        
        // Check if meal plan data was passed
        window.addEventListener('load', function() {
            updateTime();
            setInterval(updateTime, 1000);
            
            const urlParams = new URLSearchParams(window.location.search);
            const planId = urlParams.get('planId');
            
            console.log('üîç Looking for plan ID:', planId);
            
            if (planId) {
                try {
                    const savedPlans = localStorage.getItem('fuelfire_meal_plans');
                    const mealPlans = savedPlans ? JSON.parse(savedPlans) : [];
                    const plan = mealPlans.find(p => p.id === planId);
                    
                    if (plan) {
                        console.log('‚úÖ Found meal plan in localStorage');
                        console.log('üîç MEAL PLAN DATA:', plan.mealPlan);
                        displayMealPlan(plan.mealPlan, plan.metadata);
                    } else {
                        console.log('‚ùå Plan not found in localStorage');
                        document.getElementById('meal-plan-content').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <h3>üîç Meal Plan Not Found</h3>
                                <p>This meal plan may have been deleted or expired.</p>
                                <button onclick="window.location.href='enhanced-diet-quiz.html'" style="background: var(--gradient-1); color: white; border: none; padding: 10px 20px; border-radius: 15px;">üéØ Create New Plan</button>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('‚ùå Error loading meal plan:', error);
                    document.getElementById('meal-plan-content').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <h3>‚ö†Ô∏è Error Loading Plan</h3>
                            <p>There was an error loading your meal plan.</p>
                            <button onclick="window.location.href='enhanced-diet-quiz.html'" style="background: var(--gradient-1); color: white; border: none; padding: 10px 20px; border-radius: 15px;">üéØ Try Again</button>
                        </div>
                    `;
                }
            } else {
                console.log('‚ùå No plan ID provided');
                document.getElementById('meal-plan-content').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>üîç No Meal Plan</h3>
                        <p>Please generate a meal plan first.</p>
                        <button onclick="window.location.href='enhanced-diet-quiz.html'" style="background: var(--gradient-1); color: white; border: none; padding: 10px 20px; border-radius: 15px;">üéØ Start Quiz</button>
                    </div>
                `;
            }
        });
    </script>

    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <!-- Quick Workout -->
        <div class="nav-item" onclick="window.location.href='workout-quiz.html'">
            <div class="nav-glow"></div>
            <div class="nav-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="9" width="4" height="6" rx="1" fill="white"/>
                    <rect x="18" y="9" width="4" height="6" rx="1" fill="white"/>
                    <rect x="6" y="11" width="12" height="2" rx="1" fill="white"/>
                    <circle cx="4" cy="12" r="1.5" fill="#4B9CD3"/>
                    <circle cx="20" cy="12" r="1.5" fill="#4B9CD3"/>
                </svg>
            </div>
        </div>
        <!-- Food Tracker -->
        <div class="nav-item" onclick="window.location.href='calorie-tracker.html'">
            <div class="nav-glow"></div>
            <div class="nav-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="9" stroke="white" stroke-width="2" fill="none"/>
                    <path d="M12 3C12 3 16 8 16 12C16 14.2 14.2 16 12 16C9.8 16 8 14.2 8 12C8 8 12 3 12 3Z" stroke="white" stroke-width="2" fill="none"/>
                </svg>
            </div>
        </div>
        <!-- Home (Center, Larger) -->
        <div class="nav-item" onclick="window.location.href='index.html'" style="transform: scale(1.2);">
            <div class="nav-glow"></div>
            <div class="nav-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 22V12H15V22" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
        </div>
        <!-- Health Dashboard -->
        <div class="nav-item" onclick="window.location.href='health-dashboard.html'">
            <div class="nav-glow"></div>
            <div class="nav-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.27 2 8.5C2 5.41 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.08C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.41 22 8.5C22 12.27 18.6 15.36 13.45 20.03L12 21.35Z" fill="white"/>
                </svg>
            </div>
        </div>
        <!-- Workout Techniques -->
        <div class="nav-item" onclick="window.location.href='workout-techniques.html'">
            <div class="nav-glow"></div>
            <div class="nav-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                    <circle cx="12" cy="12" r="2" fill="white"/>
                    <path d="M12 2V12L18 18" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
    </div>

</body>
</html>