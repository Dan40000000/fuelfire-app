<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your AI Meal Plan - FuelFire</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
        }
        
        .phone-container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .screen {
            background: white;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 600;
            background: white;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: var(--gradient-1);
            color: white;
        }
        
        .hamburger {
            font-size: 20px;
            cursor: pointer;
            margin-right: 15px;
        }
        
        .header-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .content {
            padding: 0;
            background: white;
            min-height: calc(100vh - 120px);
        }
        
        .plan-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f3f4;
        }
        
        .plan-title {
            color: #4B9CD3;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .plan-metadata {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .action-buttons {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            font-size: 14px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section-title {
            background: var(--gradient-1);
            color: white;
            padding: 12px 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .section-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .day-plan {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }
        
        .day-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        
        .meal {
            background: white;
            margin: 8px 0;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .meal-name {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .meal-details {
            color: #666;
            line-height: 1.4;
            font-size: 13px;
        }
        
        .shopping-section {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }
        
        .shopping-list {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .shopping-category {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .shopping-items {
            line-height: 1.5;
            color: #333;
            font-size: 13px;
        }
        
        .nutrition-summary {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .nutrition-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }
        
        .tips-section {
            background: #e7f3ff;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #007bff;
        }
        
        .footer-section {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 15px;
        }
        
        @media print {
            .action-buttons { display: none; }
            .meal-plan-container { background: white !important; }
        }
        
        @media (max-width: 768px) {
            .meal-plan-container { padding: 10px; }
            .meal-plan-content { padding: 20px; }
            .plan-title { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="screen">
            <div class="status-bar">
                <span id="time">9:41</span>
                <span>100%</span>
            </div>
            
            <div class="header">
                <div class="hamburger" onclick="goBack()">‚Üê</div>
                <div class="header-title">Your Meal Plan</div>
            </div>
            
            <div class="content">
                <div style="padding: 20px;">
                    <div class="plan-header">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="color: var(--primary); margin: 0 0 10px 0; font-size: 24px;">üéØ AI Meal Plan</h2>
                            <div class="plan-metadata" id="plan-metadata" style="background: #f8f9ff; padding: 10px; border-radius: 10px; font-size: 14px; color: #666;">
                                <!-- Metadata will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons" style="text-align: center; margin-bottom: 20px;">
                        <button onclick="window.print()" style="background: var(--gradient-1); color: white; border: none; padding: 8px 16px; border-radius: 15px; font-size: 12px; margin: 0 5px;">üñ®Ô∏è Print</button>
                        <button onclick="sharePlan()" style="background: var(--gradient-1); color: white; border: none; padding: 8px 16px; border-radius: 15px; font-size: 12px; margin: 0 5px;">üì§ Share</button>
                    </div>
                    
                    <div id="meal-plan-content">
                        <!-- Meal plan content will be inserted here -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding: 15px; background: #f8f9ff; border-radius: 15px;">
                        <h4 style="color: var(--primary); margin: 0 0 8px 0;">üî• FuelFire & Claude AI</h4>
                        <p style="color: #666; margin: 0; font-size: 12px;">Personalized meal plan generated using AI</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function goBack() {
            window.location.href = 'meal-plans.html';
        }
        
        function sharePlan() {
            if (navigator.share) {
                navigator.share({
                    title: 'My AI Meal Plan - FuelFire',
                    text: 'Check out my personalized meal plan generated by AI!',
                    url: window.location.href
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                    alert('üìã Plan URL copied to clipboard!');
                });
            }
        }
        
        // Function to receive and display meal plan data
        function displayMealPlan(mealPlan, metadata) {
            console.log('üìã Displaying meal plan:', {
                mealPlanLength: mealPlan ? mealPlan.length : 0,
                mealPlanType: typeof mealPlan,
                metadataKeys: metadata ? Object.keys(metadata) : []
            });
            
            // Set metadata
            document.getElementById('plan-metadata').innerHTML = `
                üéØ <strong>Generated:</strong> ${new Date(metadata.generatedAt || metadata.createdAt).toLocaleDateString()} | 
                <strong>Goal:</strong> ${metadata.goal} | 
                <strong>Duration:</strong> ${metadata.planDuration || '2-week'}
            `;
            
            // Process and display meal plan content
            if (!mealPlan || mealPlan.length === 0) {
                document.getElementById('meal-plan-content').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>‚ö†Ô∏è Empty Meal Plan</h3>
                        <p>The meal plan appears to be empty. Please try generating a new one.</p>
                        <button onclick="window.location.href='enhanced-diet-quiz.html'" style="background: var(--gradient-1); color: white; border: none; padding: 10px 20px; border-radius: 15px;">üéØ Start New Quiz</button>
                    </div>
                `;
                return;
            }
            
            const processedContent = processMealPlanContent(mealPlan);
            document.getElementById('meal-plan-content').innerHTML = processedContent;
        }
        
        function processMealPlanContent(rawContent) {
            console.log('üîß Processing meal plan content, length:', rawContent.length);
            console.log('First 500 chars:', rawContent.substring(0, 500));
            
            // If content appears to be HTML already, extract text content
            if (rawContent.includes('<h') || rawContent.includes('<p>')) {
                console.log('‚úÖ Stripping HTML tags from content');
                // Create a temporary div to extract text content
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = rawContent;
                rawContent = tempDiv.textContent || tempDiv.innerText || rawContent;
            }
            
            // Create beautiful organized content
            let organizedContent = '';
            
            // Split by days more flexibly
            const dayPatterns = [
                { pattern: /Day \d+:/gi, name: 'Day X:' },
                { pattern: /### Day \d+/gi, name: '### Day X' },
                { pattern: /## Day \d+/gi, name: '## Day X' },
                { pattern: /\*\*Day \d+/gi, name: '**Day X' },
                { pattern: /Day \d+ -/gi, name: 'Day X -' },
                { pattern: /\n\d+\./gi, name: 'Number list' }
            ];
            
            let days = [];
            let dayFound = false;
            let matchedPattern = null;
            
            // Try different patterns to find days
            for (const patternObj of dayPatterns) {
                const matches = rawContent.match(patternObj.pattern);
                if (matches && matches.length > 1) {
                    console.log(`üîç Testing pattern '${patternObj.name}': found ${matches.length} matches`);
                    
                    // Get all day markers
                    const dayMarkers = [...rawContent.matchAll(patternObj.pattern)];
                    console.log(`üìç Day markers found at positions:`, dayMarkers.map(m => m.index));
                    
                    // Split content by day markers
                    days = [];
                    for (let i = 0; i < dayMarkers.length; i++) {
                        const start = dayMarkers[i].index + dayMarkers[i][0].length;
                        const end = i < dayMarkers.length - 1 ? dayMarkers[i + 1].index : rawContent.length;
                        const dayContent = rawContent.substring(start, end).trim();
                        if (dayContent) {
                            days.push(dayContent);
                        }
                    }
                    
                    if (days.length > 1) {
                        dayFound = true;
                        matchedPattern = patternObj.name;
                        console.log(`‚úÖ Successfully extracted ${days.length} days using pattern: ${patternObj.name}`);
                        break;
                    }
                }
            }
            
            // If no days found, check if it's already showing HTML for days
            if (!dayFound && rawContent.includes('Daily Meal Plans')) {
                console.log('‚ö†Ô∏è Content may already be formatted, checking for daily sections...');
                // Try to extract content between day headers
                const dayHeaderPattern = /<h3[^>]*>Day \d+[^<]*<\/h3>/gi;
                const dayHeaders = rawContent.match(dayHeaderPattern);
                if (dayHeaders && dayHeaders.length > 1) {
                    console.log(`üìÖ Found ${dayHeaders.length} day headers in HTML content`);
                    days = [rawContent]; // Process as is
                    dayFound = true;
                }
            }
            
            // If still no days found, try to parse as a single block
            if (!dayFound) {
                console.log('‚ö†Ô∏è No day patterns found, showing full content');
                console.log('Content preview:', rawContent.substring(0, 200));
                days = [rawContent];
            }
            
            // Format daily meal plans
            if (days.length > 0) {
                organizedContent += `
                    <div class="section">
                        <div class="section-title" style="background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%); margin-bottom: 20px;">
                            <span class="section-icon">üìÖ</span>
                            14-Day Meal Plan
                        </div>
                `;
                
                console.log(`üìä Processing ${days.length} days...`);
                
                // If we only found one "day" but it contains multiple days, try to extract them
                if (days.length === 1 && !dayFound) {
                    console.log('üîÑ Single block detected, checking for embedded days...');
                    const singleContent = days[0];
                    
                    // Check if the content has multiple day references
                    const dayReferences = singleContent.match(/Day \d+/gi);
                    if (dayReferences && dayReferences.length > 1) {
                        console.log(`Found ${dayReferences.length} day references, attempting to show all content...`);
                        
                        // Show the entire content in a scrollable format
                        organizedContent += `
                            <div style="background: #f8f9ff; border-radius: 20px; padding: 20px; margin-bottom: 20px;">
                                <h3 style="color: #4B9CD3; margin-bottom: 20px;">üìÖ Your Complete 14-Day Meal Plan</h3>
                                <div style="white-space: pre-wrap; line-height: 1.8; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                                    ${singleContent}
                                </div>
                            </div>
                        `;
                    } else {
                        // Show as Day 1 only
                        organizedContent += `
                            <div class="day-plan" style="background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%); margin-bottom: 20px; border-radius: 20px; overflow: hidden; box-shadow: 0 3px 15px rgba(0,0,0,0.08);">
                                <div class="day-title" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; font-size: 18px; font-weight: bold;">
                                    Week 1 - Monday (Day 1)
                                </div>
                                <div style="padding: 20px;">
                                    ${formatDayContent(singleContent)}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Multiple days found - display each one
                    days.forEach((dayContent, index) => {
                        if (dayContent.trim()) {
                            const dayNum = index + 1;
                            const weekNum = dayNum <= 7 ? 1 : 2;
                            const dayInWeek = ((dayNum - 1) % 7) + 1;
                            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                            const dayName = dayNames[(dayInWeek - 1)];
                            
                            console.log(`üìÖ Rendering Day ${dayNum} (${dayName})`);
                            
                            organizedContent += `
                                <div class="day-plan" style="background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%); margin-bottom: 20px; border-radius: 20px; overflow: hidden; box-shadow: 0 3px 15px rgba(0,0,0,0.08);">
                                    <div class="day-title" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; font-size: 18px; font-weight: bold;">
                                        Week ${weekNum} - ${dayName} (Day ${dayNum})
                                    </div>
                                    <div style="padding: 20px;">
                                        ${formatDayContent(dayContent)}
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
                
                organizedContent += `</div>`;
            }
            
            // Extract and format shopping lists
            const shoppingListsContent = extractShoppingLists(rawContent);
            if (shoppingListsContent) {
                organizedContent += shoppingListsContent;
            }
            
            // Extract meal prep tips
            const mealPrepContent = extractMealPrep(rawContent);
            if (mealPrepContent) {
                organizedContent += mealPrepContent;
            }
            
            // Extract nutrition summary
            const nutritionContent = extractNutrition(rawContent);
            if (nutritionContent) {
                organizedContent += nutritionContent;
            }
            
            return organizedContent;
        }
        
        function extractShoppingLists(content) {
            const patterns = [
                /üõí[\s\S]*?Shopping Lists?[\s\S]*?(?=üë®‚Äçüç≥|üìä|Meal Prep|Nutrition|$)/gi,
                /Shopping Lists?[\s\S]*?(?=Meal Prep|Nutrition|$)/gi
            ];
            
            let shoppingContent = null;
            for (const pattern of patterns) {
                const match = content.match(pattern);
                if (match) {
                    shoppingContent = match[0];
                    break;
                }
            }
            
            if (!shoppingContent) return null;
            
            // Extract Week 1 and Week 2
            const week1Match = shoppingContent.match(/Week 1[\s\S]*?(?=Week 2|$)/i);
            const week2Match = shoppingContent.match(/Week 2[\s\S]*?$/i);
            
            let formatted = `
                <div class="section">
                    <div class="section-title" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);">
                        <span class="section-icon">üõí</span>
                        Shopping Lists
                    </div>
            `;
            
            if (week1Match) {
                formatted += `
                    <div class="shopping-list" style="background: #f0fff0; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #28a745; margin-bottom: 15px; font-size: 18px;">üìã Week 1 Shopping List</h3>
                        ${formatShoppingContent(week1Match[0])}
                    </div>
                `;
            }
            
            if (week2Match) {
                formatted += `
                    <div class="shopping-list" style="background: #f0fff0; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #28a745; margin-bottom: 15px; font-size: 18px;">üìã Week 2 Shopping List</h3>
                        ${formatShoppingContent(week2Match[0])}
                    </div>
                `;
            }
            
            formatted += `</div>`;
            return formatted;
        }
        
        function formatDayContent(dayContent) {
            // Parse meals more flexibly
            const mealPatterns = [
                { icon: 'üç≥', name: 'Breakfast', patterns: [/\*\*üç≥ Breakfast:\*\*/gi, /Breakfast:/gi, /üç≥ Breakfast/gi] },
                { icon: 'ü•ó', name: 'Lunch', patterns: [/\*\*ü•ó Lunch:\*\*/gi, /Lunch:/gi, /ü•ó Lunch/gi] },
                { icon: 'üçΩÔ∏è', name: 'Dinner', patterns: [/\*\*üçΩÔ∏è Dinner:\*\*/gi, /Dinner:/gi, /üçΩÔ∏è Dinner/gi] },
                { icon: 'üçé', name: 'Snacks', patterns: [/\*\*üçé Snacks?:\*\*/gi, /Snacks?:/gi, /üçé Snacks?/gi] }
            ];
            
            let formattedContent = '';
            let remainingContent = dayContent;
            
            mealPatterns.forEach(mealType => {
                let mealContent = null;
                let mealFound = false;
                
                // Try each pattern for this meal type
                for (const pattern of mealType.patterns) {
                    const matches = remainingContent.match(new RegExp(`${pattern.source}([\\s\\S]*?)(?=${mealPatterns.map(m => m.patterns.map(p => p.source).join('|')).join('|')}|Daily Total|$)`, 'i'));
                    if (matches) {
                        mealContent = matches[1];
                        mealFound = true;
                        break;
                    }
                }
                
                if (mealFound && mealContent) {
                    // Clean up the meal content
                    mealContent = mealContent.trim()
                        .replace(/\*\*/g, '')
                        .replace(/^[\s-]+/, '')
                        .replace(/\n\s*\n/g, '\n');
                    
                    formattedContent += `
                        <div class="meal" style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            <div class="meal-name" style="font-size: 16px; font-weight: bold; color: #4B9CD3; margin-bottom: 10px; display: flex; align-items: center;">
                                <span style="font-size: 20px; margin-right: 8px;">${mealType.icon}</span>
                                ${mealType.name}
                            </div>
                            <div class="meal-details" style="color: #333; line-height: 1.6; font-size: 14px;">
                                ${formatMealDetails(mealContent)}
                            </div>
                        </div>
                    `;
                }
            });
            
            // Add daily totals if present
            const totalsMatch = dayContent.match(/Daily Total:?([\s\S]*?)(?=\n\n|$)/i);
            if (totalsMatch) {
                formattedContent += `
                    <div style="background: #f0f8ff; border-radius: 10px; padding: 15px; margin-top: 15px; border-left: 4px solid #4B9CD3;">
                        <strong style="color: #4B9CD3;">üìä Daily Totals:</strong>
                        <div style="color: #666; margin-top: 5px; font-size: 14px;">${totalsMatch[1].trim()}</div>
                    </div>
                `;
            }
            
            return formattedContent || `<div style="color: #666; line-height: 1.6;">${dayContent}</div>`;
        }
        
        function formatMealDetails(mealContent) {
            // Format meal details with better structure
            let formatted = mealContent;
            
            // Convert line breaks to HTML
            formatted = formatted.split('\n').map(line => {
                line = line.trim();
                if (!line) return '';
                
                // Check if it's a nutrition line (contains calories, protein, etc.)
                if (line.match(/Calories:|Protein:|Carbs:|Fat:/i)) {
                    return `<div style="background: #f8f9ff; padding: 8px 12px; border-radius: 8px; margin-top: 10px; font-size: 13px; color: #666;">${line}</div>`;
                }
                
                // Regular meal item
                return `<div style="margin-bottom: 5px;">‚Ä¢ ${line}</div>`;
            }).join('');
            
            return formatted;
        }
        
        function formatShoppingContent(content) {
            const categories = [
                { icon: 'ü•©', name: 'Proteins', patterns: [/\*\*ü•© Proteins?:\*\*/gi, /Proteins?:/gi] },
                { icon: 'ü•¨', name: 'Vegetables', patterns: [/\*\*ü•¨ Vegetables?:\*\*/gi, /Vegetables?:/gi] },
                { icon: 'üçé', name: 'Fruits', patterns: [/\*\*üçé Fruits?:\*\*/gi, /Fruits?:/gi] },
                { icon: 'ü•õ', name: 'Dairy', patterns: [/\*\*ü•õ Dairy:\*\*/gi, /Dairy:/gi] },
                { icon: 'üåæ', name: 'Pantry', patterns: [/\*\*üåæ Pantry.*?:\*\*/gi, /Pantry.*?:/gi] }
            ];
            
            let formatted = '';
            
            categories.forEach(category => {
                let categoryContent = null;
                
                for (const pattern of category.patterns) {
                    const regex = new RegExp(`${pattern.source}([\\s\\S]*?)(?=${categories.map(c => c.patterns.map(p => p.source).join('|')).join('|')}|Estimated|$)`, 'i');
                    const match = content.match(regex);
                    if (match) {
                        categoryContent = match[1];
                        break;
                    }
                }
                
                if (categoryContent) {
                    const items = categoryContent.trim().split('\n')
                        .filter(item => item.trim() && !item.match(/^\s*[-*]\s*$/))
                        .map(item => item.replace(/^\s*[-*]\s*/, '').trim());
                    
                    if (items.length > 0) {
                        formatted += `
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: #28a745; font-size: 16px; margin-bottom: 8px;">
                                    <span style="font-size: 18px; margin-right: 5px;">${category.icon}</span>
                                    ${category.name}
                                </h4>
                                <div style="background: white; border-radius: 10px; padding: 12px;">
                                    ${items.map(item => `<div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px;">‚úì ${item}</div>`).join('')}
                                </div>
                            </div>
                        `;
                    }
                }
            });
            
            // Add estimated cost if present
            const costMatch = content.match(/Estimated.*?Cost.*?:\s*([\$\d.]+)/i);
            if (costMatch) {
                formatted += `
                    <div style="background: #fff3cd; border-radius: 10px; padding: 15px; margin-top: 15px; text-align: center;">
                        <strong style="color: #856404;">üí∞ Estimated Total: ${costMatch[1]}</strong>
                    </div>
                `;
            }
            
            return formatted || `<div style="color: #666; line-height: 1.6;">${content}</div>`;
        }
        
        function extractMealPrep(content) {
            const patterns = [
                /üë®‚Äçüç≥[\s\S]*?Meal Prep[\s\S]*?(?=üìä|Nutrition|$)/gi,
                /Meal Prep Instructions?[\s\S]*?(?=Nutrition|$)/gi
            ];
            
            let prepContent = null;
            for (const pattern of patterns) {
                const match = content.match(pattern);
                if (match) {
                    prepContent = match[0];
                    break;
                }
            }
            
            if (!prepContent) return null;
            
            return `
                <div class="section">
                    <div class="section-title" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <span class="section-icon">üë®‚Äçüç≥</span>
                        Meal Prep Instructions
                    </div>
                    <div class="tips-section" style="background: #fff0f5; border-radius: 15px; padding: 20px; line-height: 1.8;">
                        ${prepContent.replace(/\n/g, '<br>').replace(/\*\*/g, '')}
                    </div>
                </div>
            `;
        }
        
        function extractNutrition(content) {
            const patterns = [
                /üìä[\s\S]*?Nutrition[\s\S]*$/gi,
                /Nutritional Summary[\s\S]*$/gi
            ];
            
            let nutritionContent = null;
            for (const pattern of patterns) {
                const match = content.match(pattern);
                if (match) {
                    nutritionContent = match[0];
                    break;
                }
            }
            
            if (!nutritionContent) return null;
            
            return `
                <div class="section">
                    <div class="section-title" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <span class="section-icon">üìä</span>
                        Nutritional Summary
                    </div>
                    <div class="nutrition-summary" style="background: #fffaf0; border-radius: 15px; padding: 20px; line-height: 1.8;">
                        ${nutritionContent.replace(/\n/g, '<br>').replace(/\*\*/g, '')}
                    </div>
                </div>
            `;
        }
        
        // Remove old unused functions (they've been replaced above)
        
        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            document.getElementById('time').textContent = time;
        }
        
        // Check if meal plan data was passed
        window.addEventListener('load', function() {
            // Update time
            updateTime();
            setInterval(updateTime, 1000);
            
            const urlParams = new URLSearchParams(window.location.search);
            const planId = urlParams.get('planId');
            const planData = urlParams.get('data'); // Fallback for old method
            
            console.log('üîç Checking for meal plan data...');
            console.log('URL params:', urlParams.toString());
            console.log('Plan ID:', planId);
            console.log('Plan data exists:', !!planData);
            
            // Try to load from localStorage first (new method)
            if (planId) {
                try {
                    const savedPlans = localStorage.getItem('fuelfire_meal_plans');
                    const mealPlans = savedPlans ? JSON.parse(savedPlans) : [];
                    const plan = mealPlans.find(p => p.id === planId);
                    
                    if (plan) {
                        console.log('‚úÖ Successfully loaded meal plan from localStorage');
                        displayMealPlan(plan.mealPlan, plan.metadata);
                    } else {
                        throw new Error('Plan not found in localStorage');
                    }
                } catch (error) {
                    console.error('‚ùå Error loading from localStorage:', error);
                    showErrorMessage();
                }
            } 
            // Fallback to URL data method
            else if (planData) {
                try {
                    const data = JSON.parse(decodeURIComponent(planData));
                    console.log('‚úÖ Successfully parsed meal plan data from URL:', Object.keys(data));
                    displayMealPlan(data.mealPlan, data.metadata);
                } catch (error) {
                    console.error('‚ùå Error loading meal plan data:', error);
                    showErrorMessage();
                }
            } else {
                console.log('‚ùå No meal plan data found');
                showErrorMessage();
            }
        });
        
        function showErrorMessage() {
            document.getElementById('meal-plan-content').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <h3>üîç No Meal Plan Data</h3>
                    <p>Please generate a meal plan from the quiz first.</p>
                    <button onclick="goBack()" style="background: var(--gradient-1); color: white; border: none; padding: 10px 20px; border-radius: 15px;">‚Üê Back to Meal Plans</button>
                    <button onclick="window.location.href='enhanced-diet-quiz.html'" style="background: var(--gradient-1); color: white; border: none; padding: 10px 20px; border-radius: 15px; margin-left: 10px;">üéØ Start Quiz</button>
                </div>
            `;
        }
    </script>
</body>
</html>