<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Tracker - FuelFire</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="phone-container">
        <div class="screen">
            <div class="status-bar">
                <span id="time">9:41</span>
                <span>100%</span>
            </div>
            
            <div class="header">
                <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
                <div class="header-title">Calorie Tracker</div>
            </div>
            
            <div class="content">
                <div style="padding: 20px;">
                    <!-- Today's Summary -->
                    <div style="background: var(--gradient-1); color: white; padding: 25px; border-radius: 20px; margin-bottom: 25px; text-align: center;">
                        <h2 style="font-size: 18px; margin-bottom: 10px;">üìÖ Today's Progress</h2>
                        <div style="font-size: 48px; font-weight: bold; margin: 10px 0;" id="calories-today">0</div>
                        <div style="font-size: 14px; opacity: 0.9;">calories consumed</div>
                        <div style="margin-top: 20px; background: rgba(255,255,255,0.2); border-radius: 10px; padding: 10px;">
                            <div style="display: flex; justify-content: space-around; font-size: 14px;">
                                <div>
                                    <div style="font-weight: bold;">Target</div>
                                    <div id="calorie-target">2000</div>
                                </div>
                                <div>
                                    <div style="font-weight: bold;">Remaining</div>
                                    <div id="calories-remaining">2000</div>
                                </div>
                                <div>
                                    <div style="font-weight: bold;">% of Goal</div>
                                    <div id="percent-complete">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Epic Food Logging Section -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);">
                        <h3 style="color: white; text-align: center; margin: 0 0 15px 0; font-size: 20px;">üî• LOG YOUR FUEL üî•</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <button onclick="startVoiceLogging()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 15px 10px; border-radius: 15px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                                üé§<br>Voice
                            </button>
                            <button onclick="startBarcodeScanning()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 15px 10px; border-radius: 15px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                                üì∑<br>Scan
                            </button>
                            <button onclick="showSmartEntry()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 15px 10px; border-radius: 15px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.3s;">
                                ‚å®Ô∏è<br>Type
                            </button>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px;">
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-bottom: 8px;">QUICK ADD FROM HISTORY:</div>
                            <div id="quick-adds" style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;">
                                <!-- Quick add buttons will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Original Actions (Keep for meal plan access) -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 25px;">
                        <button onclick="showMealPlanSelector()" style="background: white; border: 2px solid var(--primary); color: var(--primary); padding: 12px; border-radius: 15px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 14px;">
                            üçΩÔ∏è Log from Saved Meal Plan
                        </button>
                    </div>
                    
                    <!-- Today's Meals -->
                    <div style="background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">üçΩÔ∏è Today's Meals</h3>
                        <div id="today-meals">
                            <p style="text-align: center; color: #999; padding: 20px;">No meals logged yet today</p>
                        </div>
                    </div>
                    
                    <!-- Weekly Summary -->
                    <div style="background: white; border-radius: 20px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">üìä This Week</h3>
                        <div id="weekly-chart" style="height: 150px; display: flex; align-items: flex-end; justify-content: space-around;">
                            <!-- Weekly bar chart will go here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Overlay for sidebar -->
    <div class="overlay" onclick="toggleSidebar()"></div>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">üî• FuelFire</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item" onclick="goToPage('index.html')">üè† Home</div>
            <div class="menu-item" onclick="goToPage('index.html')">üí™ Create Workout</div>
            <div class="menu-item" onclick="goToPage('index.html')">üìö Saved Workouts</div>
            <div class="menu-item" onclick="goToPage('index.html')">üìä Track Workouts</div>
            <div class="menu-item active" onclick="goToPage('calorie-tracker.html')">üî• Calorie Tracker</div>
            <div class="menu-item" onclick="goToPage('enhanced-diet-quiz.html')">üéØ Diet Creation</div>
            <div class="menu-item" onclick="goToPage('meal-plans.html')">üçΩÔ∏è Meal Plans</div>
            <div class="menu-item" onclick="goToPage('meal-ideas.html')">üí° Meal Ideas</div>
            <div class="menu-item" onclick="goToPage('index.html')">üìà Progress & Analytics</div>
        </div>
    </div>
    
    <!-- Manual Entry Modal -->
    <div id="manual-entry-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 350px;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">‚ûï Add Food</h3>
            <input type="text" id="food-name" placeholder="Food name" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px;">
            <input type="number" id="food-calories" placeholder="Calories" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <button onclick="addManualFood()" style="flex: 1; background: var(--gradient-1); color: white; border: none; padding: 12px; border-radius: 15px; font-weight: bold;">Add</button>
                <button onclick="hideManualEntry()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 15px; font-weight: bold;">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Meal Plan Selector Modal -->
    <div id="meal-plan-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">üçΩÔ∏è Log from Meal Plan</h3>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">Select Meal Plan:</label>
                <select id="meal-plan-select" onchange="loadMealPlanMeals()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px;">
                    <option value="">Choose a meal plan...</option>
                </select>
            </div>
            
            <div id="meal-plan-meals" style="display: none;">
                <label style="display: block; font-weight: bold; margin-bottom: 8px;">Select Meal:</label>
                <select id="meal-select" onchange="showMealTypeSelector()" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px;">
                    <option value="">Choose a meal...</option>
                </select>
                
                <div id="meal-type-selector" style="display: none; margin-bottom: 20px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 8px;">Log as:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="logMealFromPlan('breakfast')" style="background: #FF6B6B; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">üç≥ Breakfast</button>
                        <button onclick="logMealFromPlan('lunch')" style="background: #4ECDC4; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">ü•ó Lunch</button>
                        <button onclick="logMealFromPlan('dinner')" style="background: #3AA69D; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">üçΩÔ∏è Dinner</button>
                        <button onclick="logMealFromPlan('snack')" style="background: #F38181; color: white; border: none; padding: 10px; border-radius: 10px; font-size: 12px;">üçé Snack</button>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="hideMealPlanSelector()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 15px; font-weight: bold;">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Voice Modal -->
    <div id="voice-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 350px; text-align: center;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">üé§ Voice Logging</h3>
            <div id="voice-status" style="font-size: 48px; margin: 20px 0;">üé§</div>
            <div id="voice-text" style="min-height: 50px; padding: 15px; background: #f0f0f0; border-radius: 10px; margin-bottom: 20px; font-style: italic;">
                Click the microphone to start speaking...
            </div>
            <button onclick="toggleVoiceRecording()" id="voice-button" style="background: #FF6B6B; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer;">
                Start Recording
            </button>
            <button onclick="closeVoiceModal()" style="background: #6c757d; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; margin-left: 10px;">
                Cancel
            </button>
            <div id="food-results" style="margin-top: 20px; max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- Barcode Scanner Modal -->
    <div id="scanner-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px;">
            <video id="scanner-video" style="width: 100%; border-radius: 10px;"></video>
            <canvas id="scanner-canvas" style="display: none;"></canvas>
            <div style="text-align: center; margin-top: 20px;">
                <div style="color: white; font-size: 18px; margin-bottom: 10px;">üì∑ Point at barcode</div>
                <button onclick="closeScannerModal()" style="background: #dc3545; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: bold;">
                    Cancel
                </button>
            </div>
            <div id="scan-result" style="color: white; text-align: center; margin-top: 20px;"></div>
        </div>
    </div>
    
    <!-- Smart Entry Modal -->
    <div id="smart-entry-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 400px;">
            <h3 style="color: var(--primary); margin-bottom: 20px;">‚å®Ô∏è Smart Food Search</h3>
            <input type="text" id="smart-search" placeholder="Type food name..." onkeyup="searchFood(this.value)" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
            <div id="search-results" style="margin-top: 20px; max-height: 300px; overflow-y: auto;"></div>
            <button onclick="closeSmartEntry()" style="background: #6c757d; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; margin-top: 20px; width: 100%;">
                Cancel
            </button>
        </div>
    </div>
    
    <!-- QuaggaJS for barcode scanning -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    
    <script>
        // Voice Recognition
        let recognition = null;
        let isRecording = false;
        
        function startVoiceLogging() {
            document.getElementById('voice-modal').style.display = 'block';
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('voice-text').textContent = transcript;
                    
                    if (event.results[0].isFinal) {
                        searchFoodByVoice(transcript);
                    }
                };
                
                recognition.onerror = function(event) {
                    document.getElementById('voice-text').textContent = 'Error: ' + event.error;
                };
            } else {
                alert('Voice recognition not supported on this browser. Try Chrome or Safari.');
            }
        }
        
        function toggleVoiceRecording() {
            if (!isRecording) {
                recognition.start();
                isRecording = true;
                document.getElementById('voice-button').textContent = 'Stop Recording';
                document.getElementById('voice-button').style.background = '#28a745';
                document.getElementById('voice-status').textContent = 'üî¥';
            } else {
                recognition.stop();
                isRecording = false;
                document.getElementById('voice-button').textContent = 'Start Recording';
                document.getElementById('voice-button').style.background = '#FF6B6B';
                document.getElementById('voice-status').textContent = 'üé§';
            }
        }
        
        function closeVoiceModal() {
            document.getElementById('voice-modal').style.display = 'none';
            if (recognition) recognition.stop();
            isRecording = false;
        }
        
        // Search food from voice input using AI
        async function searchFoodByVoice(query) {
            const results = await parseWithAI(query);
            displayFoodResults(results, 'voice');
        }
        
        // AI-Powered Food Parsing
        async function parseWithAI(query) {
            try {
                console.log('ü§ñ AI parsing food:', query);
                
                // Show loading state
                document.getElementById('voice-text').textContent = `Analyzing: "${query}"...`;
                
                const response = await fetch('/api/ai-food-parser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`üçî AI found ${data.foods.length} foods from ${data.source}`);
                    if (data.message) {
                        console.log('üìù', data.message);
                    }
                    
                    // Update the voice text to show what was found
                    if (data.foods.length > 1) {
                        const foodNames = data.foods.map(f => f.name).join(' + ');
                        document.getElementById('voice-text').textContent = `Found: ${foodNames}`;
                    } else {
                        document.getElementById('voice-text').textContent = `Found: ${data.foods[0].name}`;
                    }
                    
                    return data.foods;
                } else {
                    throw new Error(data.error || 'Parsing failed');
                }
                
            } catch (error) {
                console.error('AI food parsing error:', error);
                
                // Fallback to USDA search
                console.log('üîÑ Falling back to USDA search...');
                return await searchUSDA(query);
            }
        }
        
        // USDA API Search (fallback)
        async function searchUSDA(query) {
            try {
                console.log('üîç Searching USDA for:', query);
                
                const response = await fetch('/api/usda-food-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Found ${data.foods.length} foods from ${data.source}`);
                    if (data.message) {
                        console.log('üìù', data.message);
                    }
                    return data.foods;
                } else {
                    throw new Error(data.error || 'Search failed');
                }
                
            } catch (error) {
                console.error('USDA search error:', error);
                
                // Final fallback to basic estimation
                return [{
                    name: `${query} (estimated)`,
                    calories: 350,
                    protein: 15,
                    carbs: 30,
                    fat: 15,
                    source: 'estimated'
                }];
            }
        }
        
        // Display food search results
        function displayFoodResults(foods, source) {
            const resultsDiv = document.getElementById(source === 'voice' ? 'food-results' : 'search-results');
            
            if (foods.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #666;">No foods found</p>';
                return;
            }
            
            // Check if multiple foods (from AI parsing)
            if (foods.length > 1) {
                let html = '<div style="font-weight: bold; margin-bottom: 10px; color: #4CAF50;">ü§ñ AI found multiple foods:</div>';
                
                // Store foods globally for onclick handlers
                window.currentFoods = foods;
                window.currentSource = source;
                
                // Show "Log All" button
                html += `
                    <div style="background: #4CAF50; color: white; padding: 12px; border-radius: 10px; margin-bottom: 12px; cursor: pointer; text-align: center;" 
                         onclick="logAllCurrentFoods()">
                        <div style="font-weight: bold;">‚úÖ Log All Foods</div>
                        <div style="font-size: 14px; opacity: 0.9;">Total: ${foods.reduce((sum, f) => sum + f.calories, 0)} calories</div>
                    </div>
                `;
                
                html += '<div style="font-size: 14px; margin-bottom: 8px; color: #666;">Or select individual foods:</div>';
                
                foods.forEach((food, index) => {
                    // Clean the food name for onclick
                    const cleanName = food.name.replace(/'/g, "\\'");
                    html += `
                        <div style="background: #f8f9ff; padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer;" 
                             onclick="selectFood('${cleanName}', ${food.calories}, ${food.protein || 0}, ${food.carbs || 0}, ${food.fat || 0}, '${source}')">
                            <div style="font-weight: bold;">${food.name}</div>
                            <div style="font-size: 14px; color: #666;">${food.calories} cal | P: ${food.protein || 0}g | C: ${food.carbs || 0}g | F: ${food.fat || 0}g</div>
                            ${food.serving ? `<div style="font-size: 12px; color: #999;">${food.serving}</div>` : ''}
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
            } else {
                // Single food - show normal selection
                let html = '<div style="font-weight: bold; margin-bottom: 10px;">Select food to log:</div>';
                foods.forEach((food, index) => {
                    html += `
                        <div style="background: #f8f9ff; padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer;" 
                             onclick="selectFood('${food.name}', ${food.calories}, ${food.protein || 0}, ${food.carbs || 0}, ${food.fat || 0}, '${source}')">
                            <div style="font-weight: bold;">${food.name}</div>
                            <div style="font-size: 14px; color: #666;">${food.calories} cal | P: ${food.protein || 0}g | C: ${food.carbs || 0}g | F: ${food.fat || 0}g</div>
                            ${food.serving ? `<div style="font-size: 12px; color: #999;">${food.serving}</div>` : ''}
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;
            }
        }
        
        // Log all current foods (simplified for onclick)
        function logAllCurrentFoods() {
            if (!window.currentFoods || !window.currentSource) {
                alert('Error: No foods to log');
                return;
            }
            
            const mealType = prompt('Log all foods as:\n1. Breakfast\n2. Lunch\n3. Dinner\n4. Snack\n\nEnter number (1-4):');
            const types = ['', 'breakfast', 'lunch', 'dinner', 'snack'];
            const type = types[parseInt(mealType)] || 'snack';
            
            const today = new Date().toISOString().split('T')[0];
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }
            
            let totalCalories = 0;
            let totalProtein = 0;
            let totalCarbs = 0; 
            let totalFat = 0;
            
            // Log each food
            window.currentFoods.forEach(food => {
                loggedMeals[today].meals.push({
                    name: food.name,
                    type: type,
                    calories: food.calories,
                    protein: food.protein || 0,
                    carbs: food.carbs || 0,
                    fat: food.fat || 0,
                    time: new Date().toISOString(),
                    source: window.currentSource,
                    serving: food.serving || '1 serving'
                });
                
                totalCalories += food.calories;
                totalProtein += food.protein || 0;
                totalCarbs += food.carbs || 0;
                totalFat += food.fat || 0;
            });
            
            loggedMeals[today].totalCalories += totalCalories;
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            
            // Close modals and refresh
            if (window.currentSource === 'voice') closeVoiceModal();
            if (window.currentSource === 'search') closeSmartEntry();
            
            loadTodaysMeals();
            loadQuickAdds();
            
            const foodNames = window.currentFoods.map(f => f.name).join('\n‚Ä¢ ');
            alert(`‚úÖ All foods logged as ${type}!\n\n‚Ä¢ ${foodNames}\n\nüìä Total: ${totalCalories} calories\nü•© ${totalProtein}g protein\nüçû ${totalCarbs}g carbs\nü•ë ${totalFat}g fat`);
            
            // Clear globals
            window.currentFoods = null;
            window.currentSource = null;
        }
        
        // Select and log food
        function selectFood(name, calories, protein, carbs, fat, source) {
            const mealType = prompt('Log as:\n1. Breakfast\n2. Lunch\n3. Dinner\n4. Snack\n\nEnter number (1-4):');
            const types = ['', 'breakfast', 'lunch', 'dinner', 'snack'];
            const type = types[parseInt(mealType)] || 'snack';
            
            // Log the food
            const today = new Date().toISOString().split('T')[0];
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }
            
            loggedMeals[today].meals.push({
                name: name,
                type: type,
                calories: calories,
                protein: protein,
                carbs: carbs,
                fat: fat,
                time: new Date().toISOString(),
                source: source
            });
            
            loggedMeals[today].totalCalories += calories;
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            
            // Close modal and refresh
            if (source === 'voice') closeVoiceModal();
            if (source === 'search') closeSmartEntry();
            
            loadTodaysMeals();
            loadQuickAdds();
            
            alert(`‚úÖ ${name} logged!\n\nüìä ${calories} calories\nü•© ${protein}g protein\nüçû ${carbs}g carbs\nü•ë ${fat}g fat`);
        }
        
        // Barcode Scanner
        function startBarcodeScanning() {
            document.getElementById('scanner-modal').style.display = 'block';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-video'),
                    constraints: {
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"]
                }
            }, function(err) {
                if (err) {
                    console.log(err);
                    alert('Camera access denied. Please allow camera access to scan barcodes.');
                    closeScannerModal();
                    return;
                }
                Quagga.start();
            });
            
            Quagga.onDetected(function(data) {
                const code = data.codeResult.code;
                searchByBarcode(code);
                Quagga.stop();
            });
        }
        
        async function searchByBarcode(barcode) {
            document.getElementById('scan-result').innerHTML = `<div style="background: white; color: black; padding: 10px; border-radius: 10px;">Searching for ${barcode}...</div>`;
            
            try {
                // OpenFoodFacts API (completely free)
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1) {
                    const product = data.product;
                    const name = product.product_name || 'Unknown Product';
                    const calories = product.nutriments['energy-kcal_100g'] || 0;
                    const protein = product.nutriments.proteins_100g || 0;
                    const carbs = product.nutriments.carbohydrates_100g || 0;
                    const fat = product.nutriments.fat_100g || 0;
                    
                    closeScannerModal();
                    selectFood(name, Math.round(calories), Math.round(protein), Math.round(carbs), Math.round(fat), 'barcode');
                } else {
                    document.getElementById('scan-result').innerHTML = '<div style="background: #dc3545; color: white; padding: 10px; border-radius: 10px;">Product not found. Try manual entry.</div>';
                }
            } catch (error) {
                console.error('Barcode search error:', error);
                document.getElementById('scan-result').innerHTML = '<div style="background: #dc3545; color: white; padding: 10px; border-radius: 10px;">Error searching product</div>';
            }
        }
        
        function closeScannerModal() {
            document.getElementById('scanner-modal').style.display = 'none';
            Quagga.stop();
        }
        
        // Smart Entry
        function showSmartEntry() {
            document.getElementById('smart-entry-modal').style.display = 'block';
            document.getElementById('smart-search').focus();
        }
        
        function closeSmartEntry() {
            document.getElementById('smart-entry-modal').style.display = 'none';
            document.getElementById('smart-search').value = '';
            document.getElementById('search-results').innerHTML = '';
        }
        
        async function searchFood(query) {
            if (query.length < 2) {
                document.getElementById('search-results').innerHTML = '';
                return;
            }
            
            // Show loading
            document.getElementById('search-results').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ü§ñ AI analyzing...</div>';
            
            // Use AI parsing for complex queries, USDA for simple ones
            let results;
            if (query.includes(' and ') || query.includes(' with ') || query.split(' ').length > 2) {
                // Complex query - use AI
                results = await parseWithAI(query);
            } else {
                // Simple query - use USDA
                results = await searchUSDA(query);
            }
            
            displayFoodResults(results, 'search');
        }
        
        // Load quick adds from history
        function loadQuickAdds() {
            const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            const foodCounts = {};
            
            // Count frequency of foods
            Object.values(loggedMeals).forEach(day => {
                day.meals?.forEach(meal => {
                    const key = `${meal.name}|${meal.calories}|${meal.protein}|${meal.carbs}|${meal.fat}`;
                    foodCounts[key] = (foodCounts[key] || 0) + 1;
                });
            });
            
            // Get top 5 most frequent
            const topFoods = Object.entries(foodCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const quickAddsDiv = document.getElementById('quick-adds');
            if (topFoods.length === 0) {
                quickAddsDiv.innerHTML = '<div style="color: rgba(255,255,255,0.6); font-size: 12px;">Log foods to see quick adds</div>';
                return;
            }
            
            quickAddsDiv.innerHTML = topFoods.map(([foodData, count]) => {
                const [name, calories, protein, carbs, fat] = foodData.split('|');
                return `
                    <button onclick="selectFood('${name}', ${calories}, ${protein}, ${carbs}, ${fat}, 'quick')" 
                            style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); 
                                   padding: 8px 12px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer;">
                        ${name} (${calories}cal)
                    </button>
                `;
            }).join('');
        }
        
        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            document.getElementById('time').textContent = time;
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }
        
        function goToPage(page) {
            window.location.href = page;
        }
        
        function loadTodaysMeals() {
            const today = new Date().toISOString().split('T')[0];
            const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            const todayData = loggedMeals[today] || { meals: [], totalCalories: 0 };
            
            // Get user's calorie target (default 2000)
            const userProfile = JSON.parse(localStorage.getItem('fuelfire_user_profile') || '{}');
            const target = userProfile.calorieTarget || 2000;
            
            // Update summary
            document.getElementById('calories-today').textContent = todayData.totalCalories;
            document.getElementById('calorie-target').textContent = target;
            document.getElementById('calories-remaining').textContent = Math.max(0, target - todayData.totalCalories);
            document.getElementById('percent-complete').textContent = Math.round((todayData.totalCalories / target) * 100) + '%';
            
            // Organize meals by type
            const mealsByType = {
                breakfast: [],
                lunch: [], 
                dinner: [],
                snack: []
            };
            
            todayData.meals.forEach((meal, index) => {
                const mealType = meal.type || 'snack';
                mealsByType[mealType].push({...meal, originalIndex: index});
            });
            
            // Update meals list with organized sections
            const mealsDiv = document.getElementById('today-meals');
            if (todayData.meals.length === 0) {
                mealsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No meals logged yet today</p>';
            } else {
                let mealsHTML = '';
                
                // Breakfast Section
                if (mealsByType.breakfast.length > 0) {
                    const breakfastCalories = mealsByType.breakfast.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                    const breakfastProtein = mealsByType.breakfast.reduce((sum, meal) => sum + (meal.protein || 0), 0);
                    const breakfastCarbs = mealsByType.breakfast.reduce((sum, meal) => sum + (meal.carbs || 0), 0);
                    const breakfastFat = mealsByType.breakfast.reduce((sum, meal) => sum + (meal.fat || 0), 0);
                    
                    mealsHTML += `
                        <div style="background: linear-gradient(135deg, #FFD700, #FFA500); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">üåÖ Breakfast</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${breakfastCalories}</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Calories</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(breakfastProtein)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Protein</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(breakfastCarbs)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Carbs</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(breakfastFat)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Fat</div>
                                </div>
                            </div>
                    `;
                    
                    mealsByType.breakfast.forEach((meal) => {
                        const time = new Date(meal.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        mealsHTML += `
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">${meal.name}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">${time} ${meal.fromMealPlan ? '‚Ä¢ From meal plan' : ''}</div>
                                        <div style="font-size: 13px; margin-top: 5px;">
                                            üìä ${meal.calories || 0} cal ‚Ä¢ ü•© ${Math.round(meal.protein || 0)}g protein ‚Ä¢ üçû ${Math.round(meal.carbs || 0)}g carbs ‚Ä¢ ü•ë ${Math.round(meal.fat || 0)}g fat
                                        </div>
                                    </div>
                                    <button onclick="removeMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; margin-left: 10px;">√ó</button>
                                </div>
                            </div>
                        `;
                    });
                    mealsHTML += '</div>';
                }
                
                // Lunch Section
                if (mealsByType.lunch.length > 0) {
                    const lunchCalories = mealsByType.lunch.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                    const lunchProtein = mealsByType.lunch.reduce((sum, meal) => sum + (meal.protein || 0), 0);
                    const lunchCarbs = mealsByType.lunch.reduce((sum, meal) => sum + (meal.carbs || 0), 0);
                    const lunchFat = mealsByType.lunch.reduce((sum, meal) => sum + (meal.fat || 0), 0);
                    
                    mealsHTML += `
                        <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">‚òÄÔ∏è Lunch</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${lunchCalories}</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Calories</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(lunchProtein)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Protein</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(lunchCarbs)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Carbs</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(lunchFat)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Fat</div>
                                </div>
                            </div>
                    `;
                    
                    mealsByType.lunch.forEach((meal) => {
                        const time = new Date(meal.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        mealsHTML += `
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">${meal.name}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">${time} ${meal.fromMealPlan ? '‚Ä¢ From meal plan' : ''}</div>
                                        <div style="font-size: 13px; margin-top: 5px;">
                                            üìä ${meal.calories || 0} cal ‚Ä¢ ü•© ${Math.round(meal.protein || 0)}g protein ‚Ä¢ üçû ${Math.round(meal.carbs || 0)}g carbs ‚Ä¢ ü•ë ${Math.round(meal.fat || 0)}g fat
                                        </div>
                                    </div>
                                    <button onclick="removeMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; margin-left: 10px;">√ó</button>
                                </div>
                            </div>
                        `;
                    });
                    mealsHTML += '</div>';
                }
                
                // Dinner Section
                if (mealsByType.dinner.length > 0) {
                    const dinnerCalories = mealsByType.dinner.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                    const dinnerProtein = mealsByType.dinner.reduce((sum, meal) => sum + (meal.protein || 0), 0);
                    const dinnerCarbs = mealsByType.dinner.reduce((sum, meal) => sum + (meal.carbs || 0), 0);
                    const dinnerFat = mealsByType.dinner.reduce((sum, meal) => sum + (meal.fat || 0), 0);
                    
                    mealsHTML += `
                        <div style="background: linear-gradient(135deg, #FF6B6B, #FF5722); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">üåô Dinner</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${dinnerCalories}</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Calories</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(dinnerProtein)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Protein</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(dinnerCarbs)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Carbs</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(dinnerFat)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Fat</div>
                                </div>
                            </div>
                    `;
                    
                    mealsByType.dinner.forEach((meal) => {
                        const time = new Date(meal.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        mealsHTML += `
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">${meal.name}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">${time} ${meal.fromMealPlan ? '‚Ä¢ From meal plan' : ''}</div>
                                        <div style="font-size: 13px; margin-top: 5px;">
                                            üìä ${meal.calories || 0} cal ‚Ä¢ ü•© ${Math.round(meal.protein || 0)}g protein ‚Ä¢ üçû ${Math.round(meal.carbs || 0)}g carbs ‚Ä¢ ü•ë ${Math.round(meal.fat || 0)}g fat
                                        </div>
                                    </div>
                                    <button onclick="removeMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; margin-left: 10px;">√ó</button>
                                </div>
                            </div>
                        `;
                    });
                    mealsHTML += '</div>';
                }
                
                // Snacks Section
                if (mealsByType.snack.length > 0) {
                    const snackCalories = mealsByType.snack.reduce((sum, meal) => sum + (meal.calories || 0), 0);
                    const snackProtein = mealsByType.snack.reduce((sum, meal) => sum + (meal.protein || 0), 0);
                    const snackCarbs = mealsByType.snack.reduce((sum, meal) => sum + (meal.carbs || 0), 0);
                    const snackFat = mealsByType.snack.reduce((sum, meal) => sum + (meal.fat || 0), 0);
                    
                    mealsHTML += `
                        <div style="background: linear-gradient(135deg, #9C27B0, #673AB7); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">üçé Snacks</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${snackCalories}</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Calories</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(snackProtein)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Protein</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(snackCarbs)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Carbs</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                                    <div style="font-weight: bold; font-size: 16px;">${Math.round(snackFat)}g</div>
                                    <div style="font-size: 12px; opacity: 0.9;">Fat</div>
                                </div>
                            </div>
                    `;
                    
                    mealsByType.snack.forEach((meal) => {
                        const time = new Date(meal.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        mealsHTML += `
                            <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 10px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">${meal.name}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">${time} ${meal.fromMealPlan ? '‚Ä¢ From meal plan' : ''}</div>
                                        <div style="font-size: 13px; margin-top: 5px;">
                                            üìä ${meal.calories || 0} cal ‚Ä¢ ü•© ${Math.round(meal.protein || 0)}g protein ‚Ä¢ üçû ${Math.round(meal.carbs || 0)}g carbs ‚Ä¢ ü•ë ${Math.round(meal.fat || 0)}g fat
                                        </div>
                                    </div>
                                    <button onclick="removeMeal(${meal.originalIndex})" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 12px; margin-left: 10px;">√ó</button>
                                </div>
                            </div>
                        `;
                    });
                    mealsHTML += '</div>';
                }
                
                mealsDiv.innerHTML = mealsHTML;
            }
            
            // Load weekly chart
            loadWeeklyChart();
        }
        
        function loadWeeklyChart() {
            const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            const chartDiv = document.getElementById('weekly-chart');
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            let chartHTML = '';
            const maxCalories = 3000; // Max for chart scaling
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - dayOfWeek + i + 1); // Start from Monday
                const dateStr = date.toISOString().split('T')[0];
                const dayData = loggedMeals[dateStr] || { totalCalories: 0 };
                const height = (dayData.totalCalories / maxCalories) * 100;
                const isToday = dateStr === today.toISOString().split('T')[0];
                
                chartHTML += `
                    <div style="text-align: center; flex: 1;">
                        <div style="height: 100px; display: flex; align-items: flex-end; justify-content: center;">
                            <div style="width: 30px; height: ${height}%; background: ${isToday ? 'var(--gradient-1)' : '#e0e0e0'}; border-radius: 5px 5px 0 0;"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">${days[i]}</div>
                        <div style="font-size: 11px; color: #999;">${dayData.totalCalories}</div>
                    </div>
                `;
            }
            
            chartDiv.innerHTML = chartHTML;
        }
        
        function removeMeal(index) {
            if (confirm('Remove this meal?')) {
                const today = new Date().toISOString().split('T')[0];
                const loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
                
                if (loggedMeals[today] && loggedMeals[today].meals[index]) {
                    const removedCalories = loggedMeals[today].meals[index].calories;
                    loggedMeals[today].meals.splice(index, 1);
                    loggedMeals[today].totalCalories -= removedCalories;
                    
                    localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
                    loadTodaysMeals();
                }
            }
        }
        
        function showManualEntry() {
            document.getElementById('manual-entry-modal').style.display = 'block';
            document.getElementById('food-name').focus();
        }
        
        function hideManualEntry() {
            document.getElementById('manual-entry-modal').style.display = 'none';
            document.getElementById('food-name').value = '';
            document.getElementById('food-calories').value = '';
        }
        
        function addManualFood() {
            const name = document.getElementById('food-name').value;
            const calories = parseInt(document.getElementById('food-calories').value);
            
            if (!name || !calories) {
                alert('Please enter both food name and calories');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }
            
            loggedMeals[today].meals.push({
                name: name,
                calories: calories,
                time: new Date().toISOString(),
                fromMealPlan: false
            });
            
            loggedMeals[today].totalCalories += calories;
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            
            hideManualEntry();
            loadTodaysMeals();
        }
        
        // Meal Plan Selector Functions
        let selectedMealData = null;
        
        function showMealPlanSelector() {
            // Load saved meal plans
            const savedPlans = JSON.parse(localStorage.getItem('fuelfire_saved_meal_plans') || '[]');
            const selectElement = document.getElementById('meal-plan-select');
            
            // Clear existing options
            selectElement.innerHTML = '<option value="">Choose a meal plan...</option>';
            
            if (savedPlans.length === 0) {
                selectElement.innerHTML += '<option value="">No saved meal plans found</option>';
                alert('No saved meal plans found!\n\nPlease save a meal plan first by:\n1. Going to Meal Plans\n2. Generating a meal plan\n3. Clicking "üíæ Save Plan"');
                return;
            }
            
            // Add meal plan options
            savedPlans.forEach(plan => {
                selectElement.innerHTML += `<option value="${plan.id}">${plan.name} (${plan.createdAt})</option>`;
            });
            
            document.getElementById('meal-plan-modal').style.display = 'block';
        }
        
        function hideMealPlanSelector() {
            document.getElementById('meal-plan-modal').style.display = 'none';
            document.getElementById('meal-plan-meals').style.display = 'none';
            document.getElementById('meal-type-selector').style.display = 'none';
            selectedMealData = null;
        }
        
        function loadMealPlanMeals() {
            const planId = document.getElementById('meal-plan-select').value;
            if (!planId) {
                document.getElementById('meal-plan-meals').style.display = 'none';
                return;
            }
            
            const savedPlans = JSON.parse(localStorage.getItem('fuelfire_saved_meal_plans') || '[]');
            const selectedPlan = savedPlans.find(plan => plan.id === planId);
            
            if (!selectedPlan || !selectedPlan.meals) {
                alert('No meals found in this plan');
                return;
            }
            
            const mealSelect = document.getElementById('meal-select');
            mealSelect.innerHTML = '<option value="">Choose a meal...</option>';
            
            // Group meals by day and type
            const groupedMeals = {};
            selectedPlan.meals.forEach((meal, index) => {
                const dayKey = `Day ${meal.day}`;
                if (!groupedMeals[dayKey]) groupedMeals[dayKey] = {};
                if (!groupedMeals[dayKey][meal.type]) groupedMeals[dayKey][meal.type] = [];
                groupedMeals[dayKey][meal.type].push({...meal, index});
            });
            
            // Add organized options
            Object.keys(groupedMeals).sort((a, b) => {
                const dayA = parseInt(a.replace('Day ', ''));
                const dayB = parseInt(b.replace('Day ', ''));
                return dayA - dayB;
            }).forEach(day => {
                const dayMeals = groupedMeals[day];
                ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(mealType => {
                    if (dayMeals[mealType]) {
                        dayMeals[mealType].forEach(meal => {
                            mealSelect.innerHTML += `<option value="${meal.index}">${day} - ${meal.type.charAt(0).toUpperCase() + meal.type.slice(1)}: ${meal.name}</option>`;
                        });
                    }
                });
            });
            
            document.getElementById('meal-plan-meals').style.display = 'block';
        }
        
        function showMealTypeSelector() {
            const mealIndex = document.getElementById('meal-select').value;
            if (!mealIndex) {
                document.getElementById('meal-type-selector').style.display = 'none';
                return;
            }
            
            const planId = document.getElementById('meal-plan-select').value;
            const savedPlans = JSON.parse(localStorage.getItem('fuelfire_saved_meal_plans') || '[]');
            const selectedPlan = savedPlans.find(plan => plan.id === planId);
            
            selectedMealData = selectedPlan.meals[parseInt(mealIndex)];
            document.getElementById('meal-type-selector').style.display = 'block';
        }
        
        function logMealFromPlan(logAsType) {
            if (!selectedMealData) {
                alert('Please select a meal first');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            let loggedMeals = JSON.parse(localStorage.getItem('fuelfire_logged_meals') || '{}');
            
            if (!loggedMeals[today]) {
                loggedMeals[today] = { meals: [], totalCalories: 0 };
            }
            
            const logEntry = {
                name: selectedMealData.name,
                type: logAsType,
                calories: selectedMealData.calories,
                protein: selectedMealData.protein,
                carbs: selectedMealData.carbs,
                fat: selectedMealData.fat,
                time: new Date().toISOString(),
                fromMealPlan: true,
                originalDay: selectedMealData.day,
                originalType: selectedMealData.type
            };
            
            loggedMeals[today].meals.push(logEntry);
            loggedMeals[today].totalCalories += selectedMealData.calories;
            
            localStorage.setItem('fuelfire_logged_meals', JSON.stringify(loggedMeals));
            
            alert(`‚úÖ ${selectedMealData.name} logged as ${logAsType}!\n\nüìä ${selectedMealData.calories} calories\nü•© ${selectedMealData.protein}g protein\nüçû ${selectedMealData.carbs}g carbs\nü•ë ${selectedMealData.fat}g fat`);
            
            hideMealPlanSelector();
            loadTodaysMeals();
        }
        
        // Initialize
        window.addEventListener('load', function() {
            updateTime();
            setInterval(updateTime, 1000);
            loadTodaysMeals();
            loadQuickAdds();
        });
    </script>
</body>
</html>